<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Payment - MediCare Plus</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #059669;
            --secondary-color: #047857;
            --accent-color: #10b981;
            --light-green: #ecfdf5;
            --dark-green: #064e3b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --text-muted: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --border-color: #e5e7eb;
            --vnpay-color: #0066cc;
            --momo-color: #d82d8b;
            --zalo-color: #0180c7;
            --blue-primary: #1E3A8A;
            --blue-secondary: #3B82F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--light-green) 0%, #f0fdf4 100%);
            min-height: 100vh;
        }

        .payment-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .payment-header {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .payment-header h1 {
            color: #007bff;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .breadcrumb-nav {
            background: transparent;
            padding: 0;
            margin-bottom: 20px;
        }

        .breadcrumb-nav .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .payment-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 150px);
        }

        .payment-form {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #007bff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-method-card {
            background: var(--bg-light);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .payment-method-card input[type="radio"] {
            display: none;
        }

        .payment-method-content {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .payment-method-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .vnpay-icon {
            background-color: var(--vnpay-color);
            background-image: url('https://stcd02206177151.cloud.edgevnpay.vn/assets/images/logo-icon/logo-primary.svg');
        }

        .momo-icon {
            background-color: var(--momo-color);
            background-image: url('https://developers.momo.vn/v3/assets/images/logo.png');
        }

        .zalo-icon {
            background-color: var(--zalo-color);
            background-image: url('https://stc-developers.zalopay.vn/images/logo-zalopay.svg');
        }

        .payment-method-info h5 {
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 1rem;
        }

        .payment-method-info p {
            margin-bottom: 0;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .payment-method-details {
            padding: 0;
            height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .payment-method-card.selected .payment-method-details {
            padding: 16px;
            height: auto;
            border-top: 1px solid var(--border-color);
        }

        .payment-method-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .payment-method-card.selected .bi-check-circle {
            display: inline-block !important;
        }

        .qr-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
        }

        .qr-code-placeholder {
            width: 150px;
            height: 150px;
            background-color: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .security-notice {
            margin-top: 24px;
            padding: 16px;
            background-color: var(--light-green);
            border-radius: 12px;
            color: var(--dark-green);
        }

        /* Invoice Styles */
        .invoice-container {
            background: var(--bg-white);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            height: 100%;
            overflow-y: auto;
            max-height: 90vh;
        }

        .invoice-header {
            background: linear-gradient(to right, var(--blue-primary), var(--blue-secondary));
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hospital-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hospital-logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue-secondary);
            font-size: 24px;
            font-weight: bold;
        }

        .barcode-placeholder {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 4px;
            padding: 8px 12px;
            display: inline-block;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .invoice-section {
            margin-bottom: 24px;
        }

        .invoice-section-title {
            background: linear-gradient(to right, var(--blue-primary), var(--blue-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invoice-section-title i {
            color: var(--blue-secondary);
            -webkit-text-fill-color: var(--blue-secondary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
        }

        .info-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .services-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        .services-table th, .services-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
        }

        .services-table th {
            background: #EFF6FF;
            color: var(--blue-primary);
            font-weight: 600;
        }

        .services-table tr:nth-child(even) {
            background: #F9FAFB;
        }

        .payment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: var(--bg-light);
            padding: 20px;
            border-radius: 8px;
        }

        .payment-info p {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .payment-controls label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .payment-controls select,
        .payment-controls input,
        .payment-controls textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .terms {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .terms p {
            margin-bottom: 6px;
        }

        .invoice-footer {
            border-top: 2px solid var(--blue-secondary);
            padding-top: 15px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 20px;
        }

        .action-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .payment-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .payment-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .status-pending {
            color: var(--warning-color);
            font-weight: 600;
        }

        .status-paid {
            color: var(--success-color);
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            text-align: center;
        }

        .spinner-border {
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .payment-content {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .invoice-container {
                max-height: none;
                height: auto;
            }

            .payment-details {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">
                <h5>ƒêang x·ª≠ l√Ω thanh to√°n...</h5>
                <p class="text-muted">Vui l√≤ng kh√¥ng ƒë√≥ng trang n√†y</p>
            </div>
        </div>
    </div>

    <div class="payment-container">
        <!-- Header -->
        <div class="payment-header">
            <nav class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/patient-legacy/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/patient-legacy/payment">Payments</a></li>
                    <li class="breadcrumb-item active">Online Payment</li>
                </ol>
            </nav>
            <h1><i class="bi bi-credit-card-2-front me-2"></i>Online Payment</h1>
            <p class="text-muted mb-0">Complete your appointment payment securely</p>
        </div>

        <div class="payment-content">
            <!-- Payment Form (Left Side) -->
            <div class="payment-form">
                <h3 class="section-title">
                    <i class="bi bi-wallet2"></i>
                    Choose Payment Method
                </h3>

                <form id="paymentForm" th:action="@{/receptionist/process-online-payment}" method="POST">
                    <input type="hidden" name="appointmentId" th:value="${appointmentId}">
                    <input type="hidden" name="patientId" th:value="${patientId}">
                    <input type="hidden" name="amount" th:value="${totalAmount}">
                    <input type="hidden" name="customerName" th:value="${invoiceData.fullName}">
                    <input type="hidden" name="customerPhone" th:value="${invoiceData.contact}">
                    <input type="hidden" name="customerEmail" th:value="${invoiceData.email}">
                    <input type="hidden" name="notes" id="hiddenNotes">

                    <!-- VNPay -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('vnpay')">
                        <input type="radio" name="paymentMethod" value="vnpay" id="vnpay">
                        <div class="payment-method-content">
                            <div class="payment-method-icon vnpay-icon">
                                VNP
                            </div>
                            <div class="payment-method-info">
                                <h5>VNPay</h5>
                                <p>Pay with VNPay wallet or linked bank cards</p>
                            </div>
                            <div class="ms-auto">
                                <i class="bi bi-check-circle text-success" style="display: none;"></i>
                            </div>
                        </div>
                        <div class="payment-method-details">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You will be redirected to VNPay gateway to complete the payment
                            </div>
                        </div>
                    </div>

                    <!-- MoMo -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('momo')">
                        <input type="radio" name="paymentMethod" value="momo" id="momo">
                        <div class="payment-method-content">
                            <div class="payment-method-icon momo-icon">
                                <i class="bi bi-phone"></i>
                            </div>
                            <div class="payment-method-info">
                                <h5>MoMo E-Wallet</h5>
                                <p>Pay instantly with MoMo mobile wallet</p>
                            </div>
                            <div class="ms-auto">
                                <i class="bi bi-check-circle text-success" style="display: none;"></i>
                            </div>
                        </div>
                        <div class="payment-method-details">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You will be redirected to MoMo to complete the payment
                            </div>
                        </div>
                    </div>

                    <!-- ZaloPay -->
                    <div class="payment-method-card" onclick="selectPaymentMethod('zalopay')">
                        <input type="radio" name="paymentMethod" value="zalopay" id="zalopay">
                        <div class="payment-method-content">
                            <div class="payment-method-icon zalo-icon">
                                ZP
                            </div>
                            <div class="payment-method-info">
                                <h5>ZaloPay</h5>
                                <p>Fast and secure payment with ZaloPay</p>
                            </div>
                            <div class="ms-auto">
                                <i class="bi bi-check-circle text-success" style="display: none;"></i>
                            </div>
                        </div>
                        <div class="payment-method-details">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You will be redirected to ZaloPay to complete the payment
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3 mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                        <button type="submit" class="btn btn-primary flex-fill" id="paymentButton" disabled>
                            <i class="bi bi-shield-lock me-2"></i>Proceed to Payment
                        </button>
                    </div>

                    <div class="security-notice">
                        <div class="d-flex align-items-start gap-3">
                            <i class="bi bi-shield-check fs-4"></i>
                            <div>
                                <h6 class="mb-1">Secure Payment</h6>
                                <p class="mb-0 small">Your payment information is encrypted and secure. We do not store your payment details.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Payment Summary/Invoice (Right Side) -->
            <div class="invoice-container">
                <!-- Header -->
                <div class="invoice-header">
                    <div class="hospital-info">
                        <div class="hospital-logo">
                            <i class="fas fa-hospital"></i>
                        </div>
                        <div>
                            <h2>MediCare Plus</h2>
                            <p class="mb-0">Tax Code: 123456789-0</p>
                            <p class="mb-0">123 Lang Street, Dong Da, Hanoi</p>
                        </div>
                    </div>
                    <div class="text-end">
                        <h3>INVOICE</h3>
                        <p class="mb-0">Receipt: <span th:text="${invoiceData.receiptNumber}">REC20250529001</span></p>
                        <p class="mb-0">Date: <span th:text="${#temporals.format(#temporals.createNow(), 'MMMM dd, yyyy', #locale.ENGLISH)}">July 15, 2025</span></p>
                        <div class="barcode-placeholder mt-2" th:text="${invoiceData.receiptNumber}">REC20250529001</div>
                    </div>
                </div>

                <!-- Patient Information -->
                <div class="invoice-section">
                    <h3 class="invoice-section-title">
                        <i class="fas fa-user"></i> Patient Information
                    </h3>
                    <div class="info-grid">
                        <div>
                            <p class="info-item"><span class="info-label">Patient ID:</span> <span th:text="${invoiceData.patientId}">PAT123456</span></p>
                            <p class="info-item"><span class="info-label">Full Name:</span> <span th:text="${invoiceData.fullName}">John Doe</span></p>
                            <p class="info-item"><span class="info-label">Date of Birth:</span> <span th:text="${invoiceData.dateOfBirth}">01/01/1990</span></p>
                            <p class="info-item"><span class="info-label">Gender:</span> <span th:text="${invoiceData.gender}">Male</span></p>
                        </div>
                        <div>
                            <p class="info-item"><span class="info-label">Appointment ID:</span> <span th:text="${invoiceData.appointmentId}">APP789012</span></p>
                            <p class="info-item"><span class="info-label">Payer Name:</span> <span th:text="${invoiceData.payerName}">John Doe</span></p>
                            <p class="info-item"><span class="info-label">Contact:</span> <span th:text="${invoiceData.contact}">(+84) 901 234 567</span></p>
                        </div>
                    </div>
                </div>

                <!-- Services Used -->
                <div class="invoice-section">
                    <h3 class="invoice-section-title">
                        <i class="fas fa-list-ul"></i> Services Used
                    </h3>
                    <div class="table-responsive">
                        <table class="services-table">
                            <thead>
                            <tr>
                                <th>Service ID</th>
                                <th>Service Name</th>
                                <th>Symptom</th>
                                <th>Qty</th>
                                <th>Price ($)</th>
                                <th>Tax (%)</th>
                                <th>Total ($)</th>
                                <th>Date</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="service : ${invoiceData.servicesUsed}">
                                <td th:text="${service.serviceId}">SRV001</td>
                                <td th:text="${service.serviceName}"></td>
                                <td th:text="${service.symptom}">General Medicine</td>
                                <td th:text="${service.quantity}">1</td>
                                <td th:text="${#numbers.formatDecimal(service.price, 0, 0)}">300,000</td>
                                <td th:text="${service.taxPercent}">10</td>
                                <td th:text="${#numbers.formatDecimal(service.total, 0, 0)}">330,000</td>
                                <td th:text="${service.date}">2025-07-15</td>
                            </tr>
                            <tr class="fw-bold" style="background-color: #EFF6FF;">
                                <td colspan="6" class="text-end">SubTotal:</td>
                                <td colspan="2" id="servicesSubTotal">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="invoice-section">
                    <h3 class="invoice-section-title">
                        <i class="fas fa-wallet"></i> Payment & Receipt
                    </h3>
                    <div class="payment-details">
                        <div class="payment-info">
                            <p><span class="info-label">Transaction ID:</span> <span th:text="${invoiceData.transactionId}">TRX20250529001</span></p>
                            <p><span class="info-label">Receipt Number:</span> <span th:text="${invoiceData.receiptNumber}">REC20250529001</span></p>
                            <p><span class="info-label">Total Amount:</span> <span id="calculatedTotalAmount">0</span> $</p>
                            <p><span class="info-label">Tax Amount:</span> <span id="calculatedTaxAmount">0</span> $</p>
                            <p><span class="info-label">Discount:</span> <span id="calculatedDiscountAmount">0</span> $</p>
                            <p><span class="info-label">Patient Payment:</span> <span id="calculatedPatientPayment">0</span> $</p>
                            <p><span class="info-label">Status:</span> <span id="transactionStatus" class="status-pending">Pending</span></p>
                        </div>
                        <div class="payment-controls">
                            <div class="mb-3">
                                <label for="paymentMethod">Payment Method</label>
                                <div class="form-control bg-light d-flex align-items-center">
                                    <i class="bi bi-credit-card text-primary me-2"></i>
                                    <span class="fw-semibold">Banking (Online Payment)</span>
                                </div>
                                <!-- Hidden input to maintain banking payment method -->
                                <input type="hidden" id="paymentMethod" value="Banking">
                                <div id="paymentMethodError" class="text-danger mt-1" style="display: none;">Please select a payment method</div>
                            </div>
                            <!-- Hide amount received container for online payments -->
                            <div id="amountReceivedContainer" class="mb-3" style="display: none;">
                                <label for="amountReceived">Amount Received ($)</label>
                                <input id="amountReceived" type="text" class="form-control" placeholder="Enter amount received">
                                <p id="changeReturned" class="text-muted mt-1">Change Returned: 0 $</p>
                                <div id="amountReceivedError" class="text-danger mt-1" style="display: none;">Amount must be at least equal to Patient Payment</div>
                            </div>
                            <div class="mb-3">
                                <label for="receiptNotes">Notes</label>
                                <textarea id="receiptNotes" maxlength="100" class="form-control" placeholder="Enter any notes about the online payment (max 100 characters)" rows="3"></textarea>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">Maximum 100 characters</small>
                                    <small id="charCount" class="text-muted">0/100</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 p-3" style="background-color: #e0f2fe; border-radius: 8px;">
                        <p class="mb-2"><span class="info-label">Processed By:</span> <span id="processedBy" th:text="${staffInfo.fullName}">Staff Member</span></p>
                        <p class="mb-0"><span class="info-label">Time of Payment:</span> <span id="timeOfPayment" th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm:ss')}">Not yet paid</span></p>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="invoice-section">
                    <h3 class="invoice-section-title">
                        <i class="fas fa-file-alt"></i> Terms & Conditions
                    </h3>
                    <div class="terms">
                        <p>1. Payment is due upon receipt of this invoice.</p>
                        <p>2. All services are non-refundable once provided.</p>
                        <p>3. For insurance claims, please contact your provider within 30 days.</p>
                        <p>4. Disputes must be reported to MediCare Plus within 7 days.</p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="invoice-footer">
                    <p class="fw-semibold">Thank you for choosing MediCare Plus</p>
                    <p>Contact us at (+84) 912 345 678 or contact@medicareplus.vn</p>
                    <p>123 Lang Street, Dong Da, Hanoi, Vietnam</p>
                </div>

                <!-- Action Buttons -->

            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h3 class="mb-4">Scan to Pay via Banking</h3>
            <div style="width: 180px; height: 180px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; margin: 0 auto; border-radius: 8px; border: 2px dashed #6B7280;">
                [Simulated QR Code]
            </div>
            <p class="mt-3">Amount: <span id="qrAmount">0</span> $</p>
            <p>Receipt: <span id="qrReceipt" th:text="${invoiceData.receiptNumber}">REC20250529001</span></p>
            <div class="mt-4">
                <button id="simulatePayment" class="btn btn-primary">Simulate Payment</button>
                <button id="closeQrModal" class="btn btn-secondary ms-2">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="paymentConfirmModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div class="mb-4" style="width: 60px; height: 60px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i class="fas fa-exclamation-triangle text-warning fs-4"></i>
                </div>
                <h3 class="mb-3">Confirm Payment</h3>
                <p class="text-muted mb-3">Are you sure you want to process this payment?</p>
                <div class="bg-light p-3 rounded mb-4 text-start">
                    <p class="mb-2"><span class="fw-bold">Full Name:</span> <span id="confirmPatientName"></span></p>
                    <p class="mb-2"><span class="fw-bold">Amount:</span> <span id="confirmAmount"></span> $</p>
                    <p class="mb-2"><span class="fw-bold">Method:</span> <span id="confirmMethod"></span></p>
                    <div id="confirmCashDetails" style="display: none;">
                        <p class="mb-1"><span class="fw-bold">Amount Received:</span> <span id="confirmAmountReceived"></span> $</p>
                        <p class="mb-0"><span class="fw-bold">Change:</span> <span id="confirmChange"></span> $</p>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3">
                    <button id="confirmPaymentBtn" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>Confirm Payment
                    </button>
                    <button id="cancelPaymentBtn" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div id="processingModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div class="mb-4" style="width: 60px; height: 60px; background: #DBEAFE; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                    <i class="fas fa-spinner fa-spin text-primary fs-4"></i>
                </div>
                <h3 class="mb-3">Processing Payment...</h3>
                <p class="text-muted">Please wait while we process your payment.</p>
            </div>
        </div>
    </div>

    <!-- Success Popup -->
    <div id="successPopup" style="display: none; position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1001;">
        <p class="mb-0">Payment Successful!</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // T·ª∑ gi√° USD to VND (c√≥ th·ªÉ l·∫•y t·ª´ API th·ª±c t·∫ø)
        const USD_TO_VND_RATE = 24000; // 1 USD = 24,000 VND (c√≥ th·ªÉ c·∫≠p nh·∫≠t t·ª´ API)

        // Function to convert USD to VND
        function convertUSDToVND(usdAmount) {
            return usdAmount * USD_TO_VND_RATE;
        }

        // Function to format VND currency
        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Function to format number with commas for VND
        function formatVNDNumber(amount) {
            return Math.round(amount).toLocaleString('vi-VN') + ' VND';
        }

        // Payment Method Selection
        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.bi-check-circle').style.display = 'none';
            });

            document.getElementById(method).checked = true;
            document.getElementById(method).closest('.payment-method-card').classList.add('selected');
            document.getElementById(method).closest('.payment-method-card').querySelector('.bi-check-circle').style.display = 'inline-block';

            document.getElementById('paymentButton').disabled = false;
        }

        // Handle form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('Please select a payment method');
                return;
            }

            // Get notes from the receipt notes textarea
            const notes = document.getElementById('receiptNotes').value;
            document.getElementById('hiddenNotes').value = notes;

            // üî• C·∫¢I THI·ªÜN LOGIC L·∫§Y PATIENT PAYMENT - LU√îN S·ª¨ D·ª§NG PATIENT PAYMENT üî•
            let finalAmountVND = 0;
            let finalAmountUSD = 0;

            console.log('=== PAYMENT AMOUNT CALCULATION DEBUG ===');

            // METHOD 1: L·∫•y t·ª´ window.calculatedPatientPayment (∆∞u ti√™n cao nh·∫•t)
            if (window.calculatedPatientPayment && window.calculatedPatientPayment > 0) {
                finalAmountUSD = window.calculatedPatientPayment;
                finalAmountVND = convertUSDToVND(finalAmountUSD);
                console.log('‚úÖ METHOD 1 - Using window.calculatedPatientPayment: $' + finalAmountUSD + ' -> ' + finalAmountVND + ' VND');
            }
            // METHOD 2: L·∫•y t·ª´ Patient Payment element tr√™n UI (KH√îNG l·∫•y Total Amount)
            else {
                const patientPaymentElement = document.getElementById('calculatedPatientPayment');
                console.log('Patient Payment Element found:', patientPaymentElement ? 'YES' : 'NO');

                if (patientPaymentElement && patientPaymentElement.textContent) {
                    console.log('Patient Payment Element text content:', patientPaymentElement.textContent);

                    // Parse text content carefully - lo·∫°i b·ªè $ v√† kho·∫£ng tr·∫Øng
                    const cleanText = patientPaymentElement.textContent.replace(/[\$\s,]/g, '');
                    console.log('Cleaned text:', cleanText);

                    finalAmountUSD = parseFloat(cleanText);
                    console.log('Parsed USD amount:', finalAmountUSD);

                    if (!isNaN(finalAmountUSD) && finalAmountUSD > 0) {
                        finalAmountVND = convertUSDToVND(finalAmountUSD);
                        console.log('‚úÖ METHOD 2 - Using UI Patient Payment: $' + finalAmountUSD + ' -> ' + finalAmountVND + ' VND');
                    } else {
                        console.log('‚ùå METHOD 2 - Invalid parsed amount from UI');
                        finalAmountUSD = 0;
                    }
                } else {
                    console.log('‚ùå METHOD 2 - Patient Payment element not found or empty');
                }
            }

            // METHOD 3: Fallback - T√≠nh l·∫°i t·ª´ calculateAllAmounts() v√† l·∫•y PATIENT PAYMENT
            if (finalAmountVND === 0) {
                console.log('‚ö†Ô∏è Using METHOD 3 - Recalculating Patient Payment...');
                try {
                    const recalculated = calculateAllAmounts();
                    if (recalculated && recalculated.patientPayment > 0) {
                        finalAmountUSD = recalculated.patientPayment; // S·ª¨ D·ª§NG PATIENT PAYMENT
                        finalAmountVND = convertUSDToVND(finalAmountUSD);
                        console.log('‚úÖ METHOD 3 - Recalculated Patient Payment: $' + finalAmountUSD + ' -> ' + finalAmountVND + ' VND');
                    }
                } catch (calcError) {
                    console.error('Error in recalculation:', calcError);
                }
            }

            // METHOD 4: Final fallback - üö´ KH√îNG S·ª¨ D·ª§NG ORIGINAL INPUT (c√≥ th·ªÉ l√† Total Amount)
            if (finalAmountVND === 0) {
                console.log('‚ö†Ô∏è Using METHOD 4 - Emergency fallback with default Patient Payment...');

                // T√≠nh to√°n emergency fallback t·ª´ services
                try {
                    const serviceRows = document.querySelectorAll('tbody tr:not(:last-child)');
                    let emergencySubTotal = 0;
                    let emergencyQuantity = 0;

                    serviceRows.forEach((row) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 8) {
                            const total = parseFloat(cells[6].textContent.replace(/[^\d.]/g, '')) || 0;
                            const quantity = parseFloat(cells[3].textContent.trim()) || 0;
                            emergencySubTotal += total;
                            emergencyQuantity += quantity;
                        }
                    });

                    // Apply discount rules
                    let discountPercent = 0;
                    if (emergencyQuantity >= 5) discountPercent = 10;
                    else if (emergencyQuantity >= 3) discountPercent = 5;
                    else if (emergencyQuantity === 1) discountPercent = 3;

                    const discountAmount = emergencySubTotal * discountPercent / 100;
                    finalAmountUSD = emergencySubTotal - discountAmount; // PATIENT PAYMENT
                    finalAmountVND = convertUSDToVND(finalAmountUSD);

                    console.log('‚úÖ METHOD 4 - Emergency Patient Payment calculation: $' + finalAmountUSD + ' -> ' + finalAmountVND + ' VND');
                } catch (e) {
                    console.error('Emergency calculation failed:', e);
                    finalAmountUSD = 160; // Hard fallback
                    finalAmountVND = convertUSDToVND(finalAmountUSD);
                    console.log('‚úÖ METHOD 4 - Hard fallback Patient Payment: $' + finalAmountUSD + ' -> ' + finalAmountVND + ' VND');
                }
            }

            // Validate final amount
            if (finalAmountVND <= 0 || finalAmountUSD <= 0) {
                console.error('‚ùå FINAL VALIDATION FAILED');
                console.error('Final USD:', finalAmountUSD);
                console.error('Final VND:', finalAmountVND);
                alert('Invalid payment amount detected. Please refresh the page and try again.');
                return;
            }

            // LOG FINAL RESULT
            console.log('=== FINAL PAYMENT AMOUNT (PATIENT PAYMENT ONLY) ===');
            console.log('Final USD Amount (Patient Payment):', finalAmountUSD);
            console.log('Final VND Amount (Patient Payment):', finalAmountVND);
            console.log('Method Selected:', selectedMethod.value);

            // C·∫≠p nh·∫≠t amount input v·ªõi gi√° tr·ªã Patient Payment VND ch√≠nh x√°c
            document.querySelector('input[name="amount"]').value = Math.round(finalAmountVND);
            console.log('Updated form input amount to Patient Payment:', Math.round(finalAmountVND), 'VND');

            // Show loading overlay BEFORE form submission
            document.getElementById('loadingOverlay').style.display = 'flex';

            // Add delay to ensure loading overlay is visible
            setTimeout(() => {
                // Submit the form to the backend
                this.submit();
            }, 100);
        });

        // Calculate amounts and convert to VND
        // T√≠nh to√°n SubTotal v√† Payment amounts - phi√™n b·∫£n ƒë∆°n gi·∫£n v√† ch√≠nh x√°c
        function calculateAllAmounts() {
            console.log('=== Calculating All Amounts ===');

            // T√¨m t·∫•t c·∫£ c√°c h√†ng service trong table
            const serviceRows = document.querySelectorAll('tbody tr:not(:last-child)'); // Lo·∫°i tr·ª´ h√†ng SubTotal
            console.log('Found service rows:', serviceRows.length);

            let subTotal = 0;
            let totalTaxAmount = 0;
            let totalQuantity = 0;

            serviceRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    // L·∫•y d·ªØ li·ªáu t·ª´ c√°c c·ªôt
                    const quantityText = cells[3].textContent.trim();
                    const priceText = cells[4].textContent.trim();
                    const taxText = cells[5].textContent.trim();
                    const totalText = cells[6].textContent.trim();

                    // Parse numbers
                    const quantity = parseFloat(quantityText) || 0;
                    const price = parseFloat(priceText.replace(/[^\d.]/g, '')) || 0;
                    const taxPercent = parseFloat(taxText) || 0;
                    const total = parseFloat(totalText.replace(/[^\d.]/g, '')) || 0;

                    console.log(`Service ${index + 1}:`, {
                        quantity, price, taxPercent, total
                    });

                    if (quantity > 0 && price > 0 && total > 0) {
                        // C·ªông v√†o SubTotal
                        subTotal += total;

                        // T√≠nh Tax Amount = Price * Quantity * Tax%
                        totalTaxAmount += (price * quantity * taxPercent / 100);

                        // C·ªông quantity ƒë·ªÉ t√≠nh discount
                        totalQuantity += quantity;
                    }
                }
            });

            // T√≠nh discount theo rules
            let discountPercent = 0;
            if (totalQuantity >= 5) {
                discountPercent = 10;
            } else if (totalQuantity >= 3) {
                discountPercent = 5;
            } else if (totalQuantity === 1) {
                discountPercent = 3;
            }

            const discountAmount = subTotal * discountPercent / 100;
            const patientPayment = subTotal - discountAmount;

            console.log('Calculation Results:', {
                subTotal,
                totalTaxAmount,
                totalQuantity,
                discountPercent,
                discountAmount,
                patientPayment
            });

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            updateDisplayValues(subTotal, totalTaxAmount, discountAmount, patientPayment);

            // L∆∞u Patient Payment ƒë·ªÉ d√πng cho validation
            window.calculatedPatientPayment = patientPayment;

            return { subTotal, totalTaxAmount, discountAmount, patientPayment };
        }

        // Function ƒë·ªÉ c·∫≠p nh·∫≠t c√°c gi√° tr·ªã hi·ªÉn th·ªã
        function updateDisplayValues(subTotal, taxAmount, discountAmount, patientPayment) {
            // SubTotal: hi·ªÉn th·ªã theo c√¥ng th·ª©c t·ªïng Total * gi√° USD hi·ªán t·∫°i
            const subTotalElement = document.getElementById('servicesSubTotal');
            if (subTotalElement) {
                subTotalElement.textContent = '$' + subTotal.toFixed(2);
            }

            // Total Amount (gi·ªëng SubTotal)
            const totalAmountElement = document.getElementById('calculatedTotalAmount');
            if (totalAmountElement) {
                totalAmountElement.textContent = '$' + subTotal.toFixed(2);
            }

            // Tax Amount - hi·ªÉn th·ªã USD
            const taxAmountElement = document.getElementById('calculatedTaxAmount');
            if (taxAmountElement) {
                taxAmountElement.textContent = '$' + taxAmount.toFixed(2);
            }

            // Discount Amount - hi·ªÉn th·ªã USD
            const discountAmountElement = document.getElementById('calculatedDiscountAmount');
            if (discountAmountElement) {
                discountAmountElement.textContent = '$' + discountAmount.toFixed(2);
            }

            // Patient Payment - hi·ªÉn th·ªã USD
            const patientPaymentElement = document.getElementById('calculatedPatientPayment');
            if (patientPaymentElement) {
                patientPaymentElement.textContent = '$' + patientPayment.toFixed(2);
            }

            // Update the hidden amount input to VND for payment processing
            const amountInput = document.querySelector('input[name="amount"]');
            if (amountInput) {
                const patientPaymentVND = convertUSDToVND(patientPayment);
                amountInput.value = patientPaymentVND;
            }
        }

        // Update service table headers and price cells to show VND
        function updateServiceTableToVND() {
            // Kh√¥ng c·∫ßn update table headers n·ªØa - gi·ªØ nguy√™n USD
            // Price v√† Total s·∫Ω hi·ªÉn th·ªã USD

            // Kh√¥ng update price cells trong service table n·ªØa
            // Gi·ªØ nguy√™n gi√° USD trong b·∫£ng service
        }

        // Character count for notes
        const receiptNotesInput = document.getElementById('receiptNotes');
        const charCountDisplay = document.getElementById('charCount');

        receiptNotesInput.addEventListener('input', function() {
            const count = this.value.length;
            charCountDisplay.textContent = count + '/100';
        });

        // Initialize calculations when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Update table headers and service prices to VND first
            setTimeout(() => {
                updateServiceTableToVND();
                calculateAllAmounts();
            }, 500);

            // Monitor for changes in the table
            const observer = new MutationObserver((mutations) => {
                let hasRelevantChanges = false;
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        hasRelevantChanges = true;
                    }
                });

                if (hasRelevantChanges) {
                    console.log('Table content changed, recalculating...');
                    setTimeout(() => {
                        updateServiceTableToVND();
                        calculateAllAmounts();
                    }, 100);
                }
            });

            // Start observing the table when available
            setTimeout(() => {
                const tableBody = document.querySelector('tbody');
                if (tableBody) {
                    observer.observe(tableBody, {
                        childList: true,
                        subtree: true,
                        characterData: true
                    });
                    console.log('Started observing table changes');
                }
            }, 1000);
        });
    </script>
</body>
</html>
