<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctors - MediCare Plus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Add jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #a78bfa;
            --light: #f8fafc;
            --dark: #3c366b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --text-muted: #9ca3af;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(102, 126, 234, 0.15);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .logo {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            text-align: left;
        }

        .logo a {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            text-decoration: none;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(45deg, #a78bfa, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }

        .logo small {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
            display: block;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.6);
            padding: 0 1.5rem;
            margin: 1.5rem 0 0.75rem;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: #a78bfa;
            border-radius: 0 4px 4px 0;
        }

        .nav-link i {
            font-size: 1.125rem;
            width: 20px;
            text-align: center;
        }

        .btn-light {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-light:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        header {
            background: var(--bg-white);
            height: var(--header-height);
            padding: 0 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--light);
            color: var(--primary);
        }

        .h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: var(--light);
        }

        .badge {
            font-size: 0.625rem;
            padding: 0.25em 0.5em;
            background: var(--error-color);
        }

        .rounded-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            object-fit: cover;
        }

        .doctor-card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.1);
            border-top: 4px solid var(--primary);
            padding: 1.5rem;
            text-align: left;
            transition: all 0.3s ease;
            position: relative; /* Add for positioning badge */
        }

        .doctor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
        }

        /* Patient Count Badge Styles */
        .patient-count-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: pulse 2s infinite;
        }

        .patient-count-badge .count-number {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1;
        }

        .patient-count-badge .count-label {
            font-size: 0.6rem;
            font-weight: 400;
            opacity: 0.9;
            line-height: 1;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
            }
            100% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
        }

        /* Responsive adjustments for badge */
        @media (max-width: 576px) {
            .patient-count-badge {
                width: 35px;
                height: 35px;
                top: 8px;
                right: 8px;
            }

            .patient-count-badge .count-number {
                font-size: 0.85rem;
            }

            .patient-count-badge .count-label {
                font-size: 0.5rem;
            }
        }

        .doctor-card .doctor-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .doctor-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .doctor-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .doctor-card p {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0;
        }

        .doctor-specialty {
            color: var(--primary);
            font-weight: 500;
        }

        .doctor-room {
            color: var(--info-color);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .doctor-room i {
            font-size: 0.75rem;
        }

        .doctor-card .btn-container {
            text-align: center;
            margin-top: 1rem;
        }

        .btn-view {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            border: none;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        .btn-view:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-book {
            background: var(--success-color);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-book:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .modal-content {
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .modal-header {
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            padding: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .detail-item {
            margin-bottom: 1rem;
        }

        .detail-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: block;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 0.875rem;
            color: var(--text-dark);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .search-section {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .search-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-title i {
            color: var(--primary);
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .search-bar button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.125rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .search-bar button:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .filter-section {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .filter-dropdown {
            min-width: 200px;
        }

        .filter-dropdown select {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .filter-dropdown select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .clear-filters-btn {
            background: var(--text-muted);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: var(--text-dark);
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .export-btn {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .results-info {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Pagination Styles */
        .pagination-section {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .pagination-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-color);
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .pagination-btn:disabled {
            background: var(--bg-light);
            border-color: #e0e0e0;
            color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination-prev,
        .pagination-next {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .pagination-prev:hover:not(:disabled),
        .pagination-next:hover:not(:disabled) {
            background: var(--secondary);
            border-color: var(--secondary);
            transform: translateY(-1px);
        }

        .pagination-prev:disabled,
        .pagination-next:disabled {
            background: var(--bg-light);
            border-color: #e0e0e0;
            color: var(--text-muted);
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .page-size-selector select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--bg-white);
        }

        /* Mobile pagination adjustments */
        @media (max-width: 768px) {
            .pagination-section {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .pagination-btn {
                min-width: 35px;
                height: 35px;
                padding: 0.25rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            header {
                padding: 0 1rem;
            }

            .doctor-card {
                padding: 1rem;
            }
        }

        @media (max-width: 576px) {
            .doctor-card img {
                width: 60px;
                height: 60px;
            }

            .doctor-card h3 {
                font-size: 1rem;
            }

            .doctor-card p, .btn-view, .btn-book {
                font-size: 0.75rem;
            }

            .btn-view, .btn-book {
                padding: 0.5rem 1rem;
            }
        }

        .main-content {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="sidebar col-lg-3 col-xl-2 d-none d-lg-block" id="patientSidebar">
            <div class="logo">
                <a href="#">
                    <i class="fas fa-user-md"></i>
                    <div>
                        <h2>MediCare Plus</h2>
                        <small>Healthcare Portal</small>
                    </div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Navigation</div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="/receptionist/dashboard" class="nav-link"><i class="fas fa-th-large"></i> Dashboard</a>
                    </li>
                    <div class="nav-section-title">Medical Services</div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="/receptionist/appointments" class="nav-link"><i class="fas fa-calendar-alt"></i> Appointments</a>
                        </li>
                        <li class="nav-item">
                            <a href="/receptionist/doctors" class="nav-link active"><i class="fas fa-user-md"></i> Doctors</a>
                        </li>
                        <li class="nav-item">
                            <a href="/receptionist/patients" class="nav-link"><i class="fas fa-users"></i> Patients</a>
                        </li>
                        <li class="nav-item">
                            <a href="/receptionist/payments" class="nav-link"><i class="fas fa-money-bill-wave"></i> Payments</a>
                        </li>
                        <li class="nav-item">
                            <a href="/receptionist/reports" class="nav-link"><i class="fas fa-chart-bar"></i> Reports</a>
                        </li>
                    </ul>
                    <div class="nav-section-title">Account</div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="/receptionist/profile" class="nav-link"><i class="fas fa-stethoscope"></i> Profile</a>
                        </li>
                    </ul>
                    <div class="nav-section-title">System</div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="/receptionist/settings" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
                        </li>
                    </ul>
                    <form class="nav-item" th:action="@{/auth/logout}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="nav-link logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </form>
                </ul>
            </nav>
        </nav>

        <main class="main-content col-lg-9 col-xl-10" id="mainContent">
            <header class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-list"></i>
                    </button>
                    <h1 class="h3">Doctors</h1>
                </div>
                <div class="profile-info">
                    <div class="notification-bell" role="button" onclick="toggleNotificationModal()">
                        <i class="fas fa-bell fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationCount">0</span>
                    </div>
                    <img src="images/profile.jpg" alt="Profile" class="rounded-circle">
                </div>
            </header>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-title">
                    <i class="fas fa-search"></i>
                    Search Doctors
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by doctor name, specialty, or email...">
                    <button type="button" onclick="searchDoctors()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="filter-section">
                    <div class="filter-dropdown">
                        <select id="specialtyFilter" class="form-select" onchange="filterDoctors()">
                            <option value="">All Specialties</option>
                        </select>
                    </div>
                    <button type="button" class="clear-filters-btn" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                    <!-- Export buttons -->
                    <div class="export-buttons">
                        <button type="button" class="export-btn excel-btn" onclick="exportToExcel()" title="Export to Excel">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button type="button" class="export-btn pdf-btn" onclick="exportToPDF()" title="Export to PDF">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>
                <div class="results-info" id="resultsInfo" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="resultsText">Showing all doctors</span>
                </div>
            </div>

            <!-- Notification Modal -->
            <div class="notification-modal" id="notificationModal">
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="doctorsGrid">
                <div class="loading" id="loadingSpinner">Loading doctors...</div>
            </div>

            <!-- Pagination Section -->
            <div class="pagination-section" id="paginationSection" style="display: none;">
                <div class="pagination-info" id="paginationInfo"></div>
                <div class="pagination-controls" id="paginationControls"></div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="doctorModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Avatar field -->
                <div class="detail-item">
                    <span class="detail-label">Avatar</span>
                    <div class="detail-value">
                        <img id="modalAvatar" src="" alt="Doctor Avatar"
                             style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;"
                             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSIyMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOWNhM2FmIj4KPHA/dGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHY0aDE2di00YzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+'; this.style.backgroundColor='#f3f4f6';">
                    </div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Full Name</span>
                    <span class="detail-value" id="modalFullName"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Email</span>
                    <span class="detail-value" id="modalEmail"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Phone Number</span>
                    <span class="detail-value" id="modalPhone"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Bio Description</span>
                    <span class="detail-value" id="modalBio"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Description</span>
                    <span class="detail-value" id="modalDescription"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Degree</span>
                    <span class="detail-value" id="modalDegree"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Institution</span>
                    <span class="detail-value" id="modalInstitution"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Specialty</span>
                    <span class="detail-value" id="modalSpecialty"></span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Room</span>
                    <span class="detail-value" id="modalRoom"></span>
                </div>
            </div>
            <!-- Modal footer with action buttons -->
            <div class="modal-footer">
                <button type="button" class="btn btn-success me-2" id="bookAppointmentBtn">
                    <i class="fas fa-calendar-plus"></i> Book Appointment
                </button>
                <button type="button" class="btn btn-info me-2" id="viewScheduleBtn">
                    <i class="fas fa-calendar-alt"></i> View Schedule & Available Times
                </button>
                <button type="button" class="btn btn-warning me-2" id="viewAppointmentsBtn">
                    <i class="fas fa-list-alt"></i> View Appointments
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let isDataLoaded = false;
    let allDoctors = []; // Store all doctors for searching/filtering
    let filteredDoctors = []; // Store filtered results
    let allSpecialties = []; // Store all specialties for filter dropdown
    let currentPage = 1;
    let pageSize = 9; // Number of doctors per page - CHANGED FROM 6 TO 9

    function toggleSidebar() {
        const sidebar = document.getElementById('patientSidebar');
        const mainContent = document.getElementById('mainContent');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
    }

    function checkScreenSize() {
        const sidebar = document.getElementById('patientSidebar');
        const mainContent = document.getElementById('mainContent');

        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
        } else {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('expanded');
        }
    }

    async function fetchDoctors() {
        try {
            const response = await fetch('/receptionist/api/doctors');
            if (!response.ok) throw new Error('Failed to fetch doctors');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching doctors:', error);
            return [];
        }
    }

    async function renderDoctors() {
        if (isDataLoaded) return;
        isDataLoaded = true;

        const grid = document.getElementById('doctorsGrid');
        const loadingSpinner = document.getElementById('loadingSpinner');

        loadingSpinner.style.display = 'block';

        allDoctors = await fetchDoctors();
        filteredDoctors = [...allDoctors]; // Initially show all doctors

        // Extract unique specialties for filter dropdown
        allSpecialties = [...new Set(allDoctors.map(doctor => doctor.specialty))].sort();
        populateSpecialtyFilter();

        grid.innerHTML = '';
        renderDoctorCards(filteredDoctors);
        updateResultsInfo();

        loadingSpinner.style.display = 'none';
    }

    function populateSpecialtyFilter() {
        const specialtyFilter = document.getElementById('specialtyFilter');
        specialtyFilter.innerHTML = '<option value="">All Specialties</option>';

        allSpecialties.forEach(specialty => {
            const option = document.createElement('option');
            option.value = specialty;
            option.textContent = specialty;
            specialtyFilter.appendChild(option);
        });
    }

    function renderDoctorCards(doctors) {
        const grid = document.getElementById('doctorsGrid');

        // Calculate pagination
        const totalDoctors = doctors.length;
        const totalPages = Math.ceil(totalDoctors / pageSize);

        // Ensure currentPage is within valid range
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        if (currentPage < 1) {
            currentPage = 1;
        }

        // Get doctors for current page only
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const doctorsToShow = doctors.slice(startIndex, endIndex);

        grid.innerHTML = '';

        if (totalDoctors === 0) {
            grid.innerHTML = '<p class="text-center text-muted col-12">No doctors found matching your criteria.</p>';
            // Hide pagination when no results
            document.getElementById('paginationSection').style.display = 'none';
        } else {
            doctorsToShow.forEach(doctor => {
                const col = document.createElement('div');
                col.className = 'col';
                col.innerHTML = `
                    <div class="doctor-card">
                        <div class="doctor-info">
                            <img src="${doctor.imageUrl || 'https://img.freepik.com/free-vector/doctor-character-background_1270-84.jpg'}" alt="${doctor.name}" />
                            <div>
                                <h3>${doctor.name}</h3>
                                <p class="doctor-specialty">${doctor.specialty}</p>
                                <p class="doctor-room"><i class="fas fa-door-open"></i> Room: ${doctor.room || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="btn-container">
                            <button class="btn-view" onclick="openDoctorModal(${doctor.id})">View</button>
                            <button class="btn-book" onclick="bookAppointmentWithDoctor(${doctor.id}, '${encodeURIComponent(doctor.name)}', '${encodeURIComponent(doctor.specialty)}')">Book</button>
                        </div>
                        <!-- Patient count badge -->
                        <div class="patient-count-badge" title="Number of Patients">
                            <div class="count-number" id="patientCount_${doctor.id}">
                                <i class="fas fa-spinner fa-spin" style="font-size: 0.8rem;"></i>
                            </div>
                            <div class="count-label">Patients</div>
                        </div>
                    </div>
                `;
                grid.appendChild(col);

                // Fetch patient count for this doctor
                fetchAndDisplayPatientCount(doctor.id);
            });

            // Show pagination and render controls
            renderPagination(totalDoctors, totalPages);
        }
    }

    function renderPagination(totalDoctors, totalPages) {
        const paginationSection = document.getElementById('paginationSection');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationControls = document.getElementById('paginationControls');

        // Only show pagination if there's more than 1 page
        if (totalPages <= 1) {
            paginationSection.style.display = 'none';
            return;
        }

        paginationSection.style.display = 'flex';

        // Update pagination info
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, totalDoctors);
        paginationInfo.textContent = `Showing ${start} - ${end} of ${totalDoctors} doctors`;

        // Clear previous controls
        paginationControls.innerHTML = '';

        // Previous button
        const prevButton = document.createElement('button');
        prevButton.className = 'pagination-btn pagination-prev';
        prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderDoctorCards(filteredDoctors); // Use current filtered data
            }
        };
        paginationControls.appendChild(prevButton);

        // Calculate which page numbers to show
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // Adjust if we're near the beginning or end
        if (currentPage <= 3) {
            endPage = Math.min(5, totalPages);
        }
        if (currentPage >= totalPages - 2) {
            startPage = Math.max(1, totalPages - 4);
        }

        // Add first page if not included
        if (startPage > 1) {
            const firstButton = document.createElement('button');
            firstButton.className = 'pagination-btn';
            firstButton.textContent = '1';
            firstButton.onclick = () => {
                currentPage = 1;
                renderDoctorCards(filteredDoctors); // Use current filtered data
            };
            paginationControls.appendChild(firstButton);

            if (startPage > 2) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '0.5rem';
                dots.style.color = 'var(--text-muted)';
                paginationControls.appendChild(dots);
            }
        }

        // Create page number buttons
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
            button.textContent = i;
            button.disabled = i === currentPage;
            button.onclick = () => {
                currentPage = i;
                renderDoctorCards(filteredDoctors); // Use current filtered data
            };
            paginationControls.appendChild(button);
        }

        // Add last page if not included
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '0.5rem';
                dots.style.color = 'var(--text-muted)';
                paginationControls.appendChild(dots);
            }

            const lastButton = document.createElement('button');
            lastButton.className = 'pagination-btn';
            lastButton.textContent = totalPages;
            lastButton.onclick = () => {
                currentPage = totalPages;
                renderDoctorCards(filteredDoctors); // Use current filtered data
            };
            paginationControls.appendChild(lastButton);
        }

        // Next button
        const nextButton = document.createElement('button');
        nextButton.className = 'pagination-btn pagination-next';
        nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderDoctorCards(filteredDoctors); // Use current filtered data
            }
        };
        paginationControls.appendChild(nextButton);
    }

    function searchDoctors() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (searchTerm === '') {
            filteredDoctors = [...allDoctors];
        } else {
            filteredDoctors = allDoctors.filter(doctor =>
                doctor.name.toLowerCase().includes(searchTerm) ||
                doctor.specialty.toLowerCase().includes(searchTerm) ||
                (doctor.email && doctor.email.toLowerCase().includes(searchTerm))
            );
        }

        // Apply specialty filter if one is selected
        const specialtyFilter = document.getElementById('specialtyFilter').value;
        if (specialtyFilter) {
            filteredDoctors = filteredDoctors.filter(doctor => doctor.specialty === specialtyFilter);
        }

        // Reset to page 1 ONLY for new search/filter
        currentPage = 1;
        renderDoctorCards(filteredDoctors);
        updateResultsInfo();
    }

    function filterDoctors() {
        const specialtyFilter = document.getElementById('specialtyFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase().trim();

        // Start with all doctors
        filteredDoctors = [...allDoctors];

        // Apply search filter
        if (searchInput) {
            filteredDoctors = filteredDoctors.filter(doctor =>
                doctor.name.toLowerCase().includes(searchInput) ||
                doctor.specialty.toLowerCase().includes(searchInput) ||
                (doctor.email && doctor.email.toLowerCase().includes(searchInput))
            );
        }

        // Apply specialty filter
        if (specialtyFilter) {
            filteredDoctors = filteredDoctors.filter(doctor => doctor.specialty === specialtyFilter);
        }

        // Reset to page 1 ONLY for new filter
        currentPage = 1;
        renderDoctorCards(filteredDoctors);
        updateResultsInfo();
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('specialtyFilter').value = '';
        filteredDoctors = [...allDoctors];
        // Reset to page 1 ONLY when clearing filters
        currentPage = 1;
        renderDoctorCards(filteredDoctors);
        updateResultsInfo();
    }

    function updateResultsInfo() {
        const resultsInfo = document.getElementById('resultsInfo');
        const resultsText = document.getElementById('resultsText');

        if (filteredDoctors.length === allDoctors.length) {
            resultsInfo.style.display = 'none';
        } else {
            resultsInfo.style.display = 'block';
            resultsText.textContent = `Showing ${filteredDoctors.length} of ${allDoctors.length} doctors`;
        }
    }

    // Enhanced booking function with automatic specialty assignment
    function bookAppointmentWithDoctor(doctorId, doctorName, doctorSpecialty) {
        // Create URL with doctor information and specialty
        const params = new URLSearchParams({
            doctorId: doctorId,
            doctorName: decodeURIComponent(doctorName),
            doctorSpecialty: decodeURIComponent(doctorSpecialty)
        });

        // Redirect to new_appointment page with parameters
        window.location.href = `/receptionist/new_appointment?${params.toString()}`;
    }

    // Add event listener for Enter key in search input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            // Prevent leading spaces in search input
            searchInput.addEventListener('input', function(e) {
                // Remove leading spaces automatically
                if (this.value.startsWith(' ')) {
                    this.value = this.value.trimStart();
                }

                // Real-time search with debounce
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchDoctors, 300);
            });

            // Prevent space key at the beginning of input
            searchInput.addEventListener('keydown', function(e) {
                // If input is empty or only contains spaces, prevent space key
                if (e.code === 'Space' && (this.value === '' || this.value.trim() === '')) {
                    e.preventDefault();
                    return false;
                }
            });

            // Handle Enter key for search
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDoctors();
                }
            });
        }

        if (!isDataLoaded) {
            renderDoctors();
        }
    });

    async function fetchDoctorDetails(id) {
        try {
            const response = await fetch(`/receptionist/api/doctors/${id}`);
            if (!response.ok) throw new Error('Failed to fetch doctor details');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching doctor details:', error);
            return null;
        }
    }

    async function openDoctorModal(id) {
        const doctor = await fetchDoctorDetails(id);
        if (!doctor) {
            alert('Failed to load doctor details.');
            return;
        }

        document.getElementById('doctorModalLabel').textContent = doctor.name || 'N/A';
        document.getElementById('modalFullName').textContent = doctor.name || 'N/A';
        document.getElementById('modalEmail').textContent = doctor.email || 'N/A';
        document.getElementById('modalPhone').textContent = doctor.phone || 'N/A';
        document.getElementById('modalBio').textContent = doctor.bio || 'N/A';
        document.getElementById('modalDescription').textContent = doctor.description || 'N/A';
        document.getElementById('modalDegree').textContent = doctor.degree || 'N/A';
        document.getElementById('modalInstitution').textContent = doctor.institution || 'N/A';
        document.getElementById('modalSpecialty').textContent = doctor.specialty || 'N/A';
        document.getElementById('modalRoom').textContent = doctor.room || 'N/A';

        // Update avatar image
        const avatarImg = document.getElementById('modalAvatar');
        avatarImg.src = doctor.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSIyMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOWNhM2FmIj4KPHA/dGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHY0aDE2di00YzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+';

        // Remove the problematic onerror handler that causes infinite loop
        avatarImg.onerror = function() {
            this.onerror = null; // Prevent infinite loop
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSIyMCIgeT0iMTUiIHdpZHRoPSI0MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOWNhM2FmIj4KPHA/dGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHY0aDE2di00YzAtMi42Ni01LjMzLTQtOC00eiIvPgo8L3N2Zz4KPC9zdmc+';
            this.style.backgroundColor = '#f3f4f6';
        };

        // Setup button event listeners
        setupModalButtonEvents(doctor);

        // Show the modal
        try {
            const doctorModal = new bootstrap.Modal(document.getElementById('doctorModal'));
            doctorModal.show();
        } catch (error) {
            console.error('Error showing modal:', error);
            // Fallback: try to show modal using jQuery if available
            if (typeof $ !== 'undefined') {
                $('#doctorModal').modal('show');
            } else {
                // Last resort: manually show modal
                const modalElement = document.getElementById('doctorModal');
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');

                // Add backdrop
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
        }
    }

    // Function to fetch patient count for a doctor
    async function fetchPatientCount(doctorId) {
        try {
            const response = await fetch(`/receptionist/api/doctors/${doctorId}/patient-count`);
            if (response.ok) {
                const data = await response.json();
                return data.count || 0;
            }
        } catch (error) {
            console.error('Error fetching patient count:', error);
        }
        return null;
    }

    // Setup event listeners for modal buttons
    // Function to fetch and display patient count for a specific doctor
    async function fetchAndDisplayPatientCount(doctorId) {
        try {
            const response = await fetch(`/receptionist/api/doctors/${doctorId}/patient-count`);
            const countElement = document.getElementById(`patientCount_${doctorId}`);

            if (!countElement) {
                console.warn(`Patient count element not found for doctor ${doctorId}`);
                return;
            }

            if (response.ok) {
                const data = await response.json();
                const count = data.count || 0;

                // Update the count display with smooth transition
                countElement.innerHTML = count;

                // Add animation class for visual feedback
                countElement.parentElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    countElement.parentElement.style.transform = 'scale(1)';
                }, 200);

            } else {
                console.error(`Failed to fetch patient count for doctor ${doctorId}:`, response.statusText);
                countElement.innerHTML = '?';
                countElement.parentElement.title = 'Unable to load patient count';
            }
        } catch (error) {
            console.error(`Error fetching patient count for doctor ${doctorId}:`, error);
            const countElement = document.getElementById(`patientCount_${doctorId}`);
            if (countElement) {
                countElement.innerHTML = '!';
                countElement.parentElement.title = 'Error loading patient count';
            }
        }
    }

    function setupModalButtonEvents(doctor) {
        // Book Appointment Button
        const bookBtn = document.getElementById('bookAppointmentBtn');
        bookBtn.onclick = () => {
            const params = new URLSearchParams({
                doctorId: doctor.id,
                doctorName: doctor.name,
                doctorSpecialty: doctor.specialty
            });
            window.location.href = `/receptionist/new_appointment?${params.toString()}`;
        };

        // View Schedule Button
        const scheduleBtn = document.getElementById('viewScheduleBtn');
        scheduleBtn.onclick = () => {
            viewDoctorSchedule(doctor.id, doctor.name);
        };

        // View Appointments Button
        const viewAppointmentsBtn = document.getElementById('viewAppointmentsBtn');
        viewAppointmentsBtn.onclick = () => {
            viewDoctorAppointments(doctor.id, doctor.name);
        };
    }

    // Function to view doctor schedule and available times
    function viewDoctorSchedule(doctorId, doctorName) {
        // Create and show schedule modal positioned next to the main modal
        const scheduleModal = document.createElement('div');
        scheduleModal.className = 'modal fade';
        scheduleModal.id = 'scheduleModal';
        scheduleModal.innerHTML = `
            <div class="modal-dialog modal-xl" style="margin-left: 60%; margin-top: 3rem; max-width: 35%; transform: translateX(0);">
                <div class="modal-content" style="border: 2px solid var(--primary); box-shadow: 0 8px 32px rgba(102, 126, 234, 0.25);">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                        <h5 class="modal-title">
                            <i class="fas fa-calendar-alt"></i>
                            Schedule & Times - Dr. ${doctorName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Date Selection Section -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-calendar"></i> Select Date
                            </h6>
                            <div class="date-selection">
                                <input type="text" id="scheduleDate" class="form-control"
                                       placeholder="MM/DD/YYYY" style="border-radius: 8px; padding: 0.75rem;">
                                <small class="text-muted">Select a date to view available time slots</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-clock"></i> Working Hours
                            </h6>
                            <div class="schedule-info">
                                <div class="schedule-item mb-2 p-2 bg-light rounded">
                                    <strong>Monday - Friday:</strong> 8:00 AM - 6:00 PM
                                </div>
                                <div class="schedule-item mb-2 p-2 bg-light rounded">
                                    <strong>Saturday:</strong> Closed
                                </div>
                                <div class="schedule-item mb-2 p-2 bg-light rounded">
                                    <strong>Sunday:</strong> Closed
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-calendar-check"></i> Available Time Slots
                            </h6>
                            <div class="date-info mb-2" id="selectedDateInfo" style="display: none;">
                                <small class="text-muted">Showing slots for: <span id="selectedDateText"></span></small>
                            </div>
                            <div class="available-slots" id="availableSlots">
                                <div class="text-center p-3 text-muted">
                                    <i class="fas fa-calendar"></i><br>
                                    Please select a date above to view available time slots.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-calendar"></i> Weekly Schedule
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-primary">
                                        <tr>
                                            <th style="font-size: 0.8rem;">Day</th>
                                            <th style="font-size: 0.8rem;">Morning</th>
                                            <th style="font-size: 0.8rem;">Afternoon</th>
                                            <th style="font-size: 0.8rem;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="weeklySchedule" style="font-size: 0.8rem;">
                                        <!-- Schedule data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success btn-sm" onclick="bookQuickAppointment(${doctorId}, '${doctorName}')">
                            <i class="fas fa-plus"></i> Book Appointment
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;

        // Append modal to body
        document.body.appendChild(scheduleModal);

        // Show modal with custom positioning
        const modal = new bootstrap.Modal(scheduleModal, {
            backdrop: false, // Disable backdrop so both modals can be visible
            keyboard: true
        });
        modal.show();

        // Initialize date picker for the schedule modal
        initializeScheduleDatePicker();

        // Load initial weekly schedule
        loadWeeklySchedule(doctorId, document.getElementById('weeklySchedule'));

        // Clean up modal when hidden
        scheduleModal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(scheduleModal);
        });

        // Add some custom styling for better positioning
        const modalElement = scheduleModal.querySelector('.modal-dialog');
        modalElement.style.position = 'fixed';
        modalElement.style.right = '2rem';
        modalElement.style.top = '3rem';
        modalElement.style.zIndex = '1060';

        // Store doctor ID for later use
        scheduleModal.setAttribute('data-doctor-id', doctorId);
    }

    // Function to initialize date picker for schedule modal
    function initializeScheduleDatePicker() {
        const dateInput = document.getElementById('scheduleDate');
        if (!dateInput) return;

        // Set minimum date to today
        const today = new Date();
        const maxDate = new Date(today);
        maxDate.setDate(today.getDate() + 30); // Allow booking up to 30 days ahead

        // Initialize jQuery UI datepicker if available
        if (typeof $ !== 'undefined' && $.fn.datepicker) {
            $(dateInput).datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: today,
                maxDate: maxDate,
                beforeShowDay: function(date) {
                    const day = date.getDay();
                    // Disable weekends (Saturday = 6, Sunday = 0)
                    const isWeekend = (day === 0 || day === 6);
                    return [!isWeekend, !isWeekend ? '' : 'ui-state-disabled',
                           isWeekend ? 'Weekend - Closed' : 'Available'];
                },
                onSelect: function(dateText) {
                    loadAvailableSlotsForDate(dateText);
                }
            });
        } else {
            // Fallback: use native date input
            dateInput.type = 'date';
            dateInput.min = formatDateForInput(today);
            dateInput.max = formatDateForInput(maxDate);

            dateInput.addEventListener('change', function() {
                const selectedDate = this.value;
                if (selectedDate) {
                    // Convert YYYY-MM-DD to MM/DD/YYYY
                    const formattedDate = formatDateFromInput(selectedDate);
                    loadAvailableSlotsForDate(formattedDate);
                }
            });
        }
    }

    // Helper function to format date for HTML date input (YYYY-MM-DD)
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Helper function to convert YYYY-MM-DD to MM/DD/YYYY
    function formatDateFromInput(dateString) {
        const parts = dateString.split('-');
        if (parts.length === 3) {
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
        return dateString;
    }

    // Function to load available slots for selected date
    async function loadAvailableSlotsForDate(dateText) {
        const availableSlotsContainer = document.getElementById('availableSlots');
        const selectedDateInfo = document.getElementById('selectedDateInfo');
        const selectedDateText = document.getElementById('selectedDateText');
        const scheduleModal = document.getElementById('scheduleModal');
        const doctorId = scheduleModal.getAttribute('data-doctor-id');

        if (!availableSlotsContainer || !doctorId) return;

        // Show selected date info
        if (selectedDateInfo && selectedDateText) {
            selectedDateText.textContent = dateText;
            selectedDateInfo.style.display = 'block';
        }

        // Show loading state
        availableSlotsContainer.innerHTML = `
            <div class="loading-slots text-center p-3">
                <i class="fas fa-spinner fa-spin"></i> Loading available slots for ${dateText}...
            </div>
        `;

        try {
            // Validate the selected date
            const validationResult = validateSelectedDate(dateText);
            if (!validationResult.isValid) {
                availableSlotsContainer.innerHTML = `
                    <div class="text-center p-3 text-warning">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        ${validationResult.message}
                    </div>
                `;
                return;
            }

            // Convert date to API format (YYYY-MM-DD)
            const dateForAPI = convertDateToAPIFormat(dateText);

            // Fetch available time slots from backend
            const response = await fetch(`/api/doctors/${doctorId}/available-slots?date=${dateForAPI}`);

            if (response.ok) {
                const data = await response.json();
                displayAvailableSlots(data.availableSlots || [], availableSlotsContainer);
            } else {
                console.warn('Failed to fetch available slots, using default schedule');
                const defaultSlots = generateDefaultTimeSlotsForDate(dateText);
                displayAvailableSlots(defaultSlots, availableSlotsContainer);
            }
        } catch (error) {
            console.error('Error fetching available slots:', error);
            availableSlotsContainer.innerHTML = `
                <div class="text-center p-3 text-danger">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Error loading schedule. Please try again.
                </div>
            `;
        }
    }

    // Function to validate selected date
    function validateSelectedDate(dateText) {
        if (!dateText) {
            return { isValid: false, message: 'Please select a date.' };
        }

        // Parse the date (MM/DD/YYYY format)
        const parts = dateText.split('/');
        if (parts.length !== 3) {
            return { isValid: false, message: 'Invalid date format.' };
        }

        const month = parseInt(parts[0]) - 1; // JavaScript months are 0-based
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);

        const selectedDate = new Date(year, month, day);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day

        // Check if date is in the past
        if (selectedDate < today) {
            return { isValid: false, message: 'Cannot select past dates. Please choose today or a future date.' };
        }

        // Check if it's a weekend
        const dayOfWeek = selectedDate.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            return { isValid: false, message: 'Appointments are not available on weekends. Please select a weekday.' };
        }

        // Check if date is too far in the future (max 30 days)
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 30);
        if (selectedDate > maxDate) {
            return { isValid: false, message: 'Cannot book appointments more than 30 days in advance.' };
        }

        return { isValid: true, message: 'Valid date' };
    }

    // Function to convert MM/DD/YYYY to YYYY-MM-DD
    function convertDateToAPIFormat(dateText) {
        const parts = dateText.split('/');
        if (parts.length === 3) {
            const month = parts[0].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        return dateText;
    }

    // Function to display available slots
    function displayAvailableSlots(slots, container) {
        if (!slots || slots.length === 0) {
            container.innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-calendar-times"></i><br>
                    No available slots today.<br>
                    <small>Doctor may be off duty or fully booked.</small>
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        // Group slots by time period
        const morningSlots = slots.filter(slot => {
            const hour = parseInt(slot.time.split(':')[0]);
            return hour < 12;
        });

        const afternoonSlots = slots.filter(slot => {
            const hour = parseInt(slot.time.split(':')[0]);
            return hour >= 12;
        });

        // Create morning section
        if (morningSlots.length > 0) {
            const morningSection = document.createElement('div');
            morningSection.className = 'mb-3';
            morningSection.innerHTML = `
                <h6 class="text-primary mb-2">
                    <i class="fas fa-sun"></i> Morning Slots
                </h6>
                <div class="slots-grid"></div>
            `;

            const morningGrid = morningSection.querySelector('.slots-grid');
            morningGrid.style.display = 'grid';
            morningGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(100px, 1fr))';
            morningGrid.style.gap = '0.5rem';

            morningSlots.forEach(slot => {
                const slotElement = createSlotElementStandard(slot);
                morningGrid.appendChild(slotElement);
            });

            container.appendChild(morningSection);
        }

        // Create afternoon section
        if (afternoonSlots.length > 0) {
            const afternoonSection = document.createElement('div');
            afternoonSection.className = 'mb-3';
            afternoonSection.innerHTML = `
                <h6 class="text-warning mb-2">
                    <i class="fas fa-cloud-sun"></i> Afternoon Slots
                </h6>
                <div class="slots-grid"></div>
            `;

            const afternoonGrid = afternoonSection.querySelector('.slots-grid');
            afternoonGrid.style.display = 'grid';
            afternoonGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(100px, 1fr))';
            afternoonGrid.style.gap = '0.5rem';

            afternoonSlots.forEach(slot => {
                const slotElement = createSlotElementStandard(slot);
                afternoonGrid.appendChild(slotElement);
            });

            container.appendChild(afternoonSection);
        }
    }

    // Function to create individual slot element following standard format
    function createSlotElementStandard(slot) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `time-slot btn btn-sm me-1 mb-1 ${slot.available ? 'btn-outline-success' : 'btn-outline-secondary disabled'}`;
        button.setAttribute('data-time', slot.time);
        button.setAttribute('onclick', `selectTimeSlot(this, '${slot.time}')`);

        // Use display text if available, otherwise format the time
        const displayTime = slot.display || formatTimeToStandard(slot.time);
        button.textContent = displayTime;

        if (slot.available) {
            button.onclick = () => selectTimeSlot(button, slot.time);
            button.style.cursor = 'pointer';
        } else {
            button.disabled = true;
            button.style.cursor = 'not-allowed';
            button.title = 'Time slot is not available';
        }

        return button;
    }

    // Function to generate default time slots for working hours (following standard format)
    function generateDefaultTimeSlots() {
        const slots = [];
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday

        // Only show slots for weekdays
        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
            // Standard morning time slots: 8:00 AM - 11:30 AM
            const morningTimes = [
                { time: '08:00:00', display: '08:00 AM' },
                { time: '08:30:00', display: '08:30 AM' },
                { time: '09:00:00', display: '09:00 AM' },
                { time: '09:30:00', display: '09:30 AM' },
                { time: '10:00:00', display: '10:00 AM' },
                { time: '10:30:00', display: '10:30 AM' },
                { time: '11:00:00', display: '11:00 AM' },
                { time: '11:30:00', display: '11:30 AM' }
            ];

            morningTimes.forEach(timeSlot => {
                slots.push({
                    time: timeSlot.time,
                    display: timeSlot.display,
                    available: true
                });
            });

            // Standard afternoon time slots: 2:00 PM - 5:30 PM
            const afternoonTimes = [
                { time: '14:00:00', display: '02:00 PM' },
                { time: '14:30:00', display: '02:30 PM' },
                { time: '15:00:00', display: '03:00 PM' },
                { time: '15:30:00', display: '03:30 PM' },
                { time: '16:00:00', display: '04:00 PM' },
                { time: '16:30:00', display: '04:30 PM' },
                { time: '17:00:00', display: '05:00 PM' },
                { time: '17:30:00', display: '05:30 PM' }
            ];

            afternoonTimes.forEach(timeSlot => {
                slots.push({
                    time: timeSlot.time,
                    display: timeSlot.display,
                    available: true
                });
            });
        }

        return slots;
    }

    // Function to generate default time slots for a specific date following standard format
    function generateDefaultTimeSlotsForDate(dateText) {
        const slots = [];

        // Validate date first
        const validationResult = validateSelectedDate(dateText);
        if (!validationResult.isValid) {
            return [];
        }

        // Standard morning time slots: 8:00 AM - 11:30 AM
        const morningTimes = [
            { time: '08:00:00', display: '08:00 AM' },
            { time: '08:30:00', display: '08:30 AM' },
            { time: '09:00:00', display: '09:00 AM' },
            { time: '09:30:00', display: '09:30 AM' },
            { time: '10:00:00', display: '10:00 AM' },
            { time: '10:30:00', display: '10:30 AM' },
            { time: '11:00:00', display: '11:00 AM' },
            { time: '11:30:00', display: '11:30 AM' }
        ];

        morningTimes.forEach(timeSlot => {
            slots.push({
                time: timeSlot.time,
                display: timeSlot.display,
                available: true
            });
        });

        // Standard afternoon time slots: 2:00 PM - 5:30 PM
        const afternoonTimes = [
            { time: '14:00:00', display: '02:00 PM' },
            { time: '14:30:00', display: '02:30 PM' },
            { time: '15:00:00', display: '03:00 PM' },
            { time: '15:30:00', display: '03:30 PM' },
            { time: '16:00:00', display: '04:00 PM' },
            { time: '16:30:00', display: '04:30 PM' },
            { time: '17:00:00', display: '05:00 PM' },
            { time: '17:30:00', display: '05:30 PM' }
        ];

        afternoonTimes.forEach(timeSlot => {
            slots.push({
                time: timeSlot.time,
                display: timeSlot.display,
                available: true
            });
        });

        return slots;
    }

    // Enhanced function to select a time slot following standard format
    function selectTimeSlot(element, timeValue) {
        // Remove previous selections
        document.querySelectorAll('.time-slot').forEach(item => {
            item.classList.remove('btn-success', 'selected');
            item.classList.add('btn-outline-success');
        });

        // Highlight selected slot
        element.classList.remove('btn-outline-success');
        element.classList.add('btn-success', 'selected');

        // Store selected time
        element.dataset.selected = 'true';

        // Visual feedback
        element.style.transform = 'scale(1.05)';
        setTimeout(() => {
            element.style.transform = 'scale(1)';
        }, 150);
    }

    // Function to view doctor appointments
    async function viewDoctorAppointments(doctorId, doctorName) {
        try {
            // Fetch appointments for this doctor
            const response = await fetch(`/api/appointments/doctor/${doctorId}`);

            if (!response.ok) {
                throw new Error('Failed to fetch appointments');
            }

            const data = await response.json();
            const appointments = data.appointments || [];

            // Create appointments modal
            const appointmentsModal = document.createElement('div');
            appointmentsModal.className = 'modal fade';
            appointmentsModal.id = 'appointmentsModal';
            appointmentsModal.innerHTML = `
                <div class="modal-dialog modal-xl" style="margin-left: 50%; margin-top: 2rem; max-width: 45%; transform: translateX(0);">
                    <div class="modal-content" style="border: 2px solid var(--warning-color); box-shadow: 0 8px 32px rgba(245, 158, 11, 0.25);">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--warning-color), #f97316); color: white;">
                            <h5 class="modal-title">
                                <i class="fas fa-list-alt"></i>
                                Appointments - Dr. ${doctorName}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 1.5rem;">
                            <div class="appointments-summary mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                            <h6 style="margin-bottom: 0.5rem; opacity: 0.9;">Total Appointments</h6>
                                            <h3 style="margin: 0; font-weight: bold;">${appointments.length}</h3>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                            <h6 style="margin-bottom: 0.5rem; opacity: 0.9;">Doctor ID</h6>
                                            <h3 style="margin: 0; font-weight: bold;">#${doctorId}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="appointments-list" id="appointmentsList">
                                ${appointments.length === 0 ?
                                    '<div class="text-center p-4 text-muted"><i class="fas fa-calendar-times fa-3x mb-3"></i><br><h5>No Appointments Found</h5><p>This doctor currently has no scheduled appointments.</p></div>' :
                                    generateAppointmentsTable(appointments)
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success btn-sm" onclick="bookAppointmentWithDoctor(${doctorId}, '${encodeURIComponent(doctorName)}', '')">
                                <i class="fas fa-plus"></i> Book New Appointment
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Append modal to body
            document.body.appendChild(appointmentsModal);

            // Show modal with custom positioning
            const modal = new bootstrap.Modal(appointmentsModal, {
                backdrop: false, // Disable backdrop so both modals can be visible
                keyboard: true
            });
            modal.show();

            // Clean up modal when hidden
            appointmentsModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(appointmentsModal);
            });

            // Add custom styling for better positioning
            const modalElement = appointmentsModal.querySelector('.modal-dialog');
            modalElement.style.position = 'fixed';
            modalElement.style.right = '2rem';
            modalElement.style.top = '2rem';
            modalElement.style.zIndex = '1060';

        } catch (error) {
            console.error('Error fetching appointments:', error);
            alert('Failed to load appointments. Please try again.');
        }
    }

    // Function to generate appointments table HTML
    function generateAppointmentsTable(appointments) {
        const tableHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th style="font-size: 0.85rem;">ID</th>
                            <th style="font-size: 0.85rem;">Patient Name</th>
                            <th style="font-size: 0.85rem;">Date & Time</th>
                            <th style="font-size: 0.85rem;">Status</th>
                            <th style="font-size: 0.85rem;">Description</th>
                            <th style="font-size: 0.85rem;">Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.map(appointment => `
                            <tr style="font-size: 0.85rem;">
                                <td>
                                    <span class="badge bg-primary">${appointment.AppointmentID}</span>
                                </td>
                                <td>
                                    <strong>${appointment.PatientName || 'Unknown Patient'}</strong>
                                    <br><small class="text-muted">Patient ID: ${appointment.PatientID}</small>
                                </td>
                                <td>
                                    <div>
                                        <i class="fas fa-calendar-alt text-primary"></i>
                                        ${formatDateTime(appointment.DateTime)}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge ${getStatusBadgeClass(appointment.Status)}">
                                        ${appointment.Status}
                                    </span>
                                </td>
                                <td>
                                    <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                        ${appointment.Description || 'No description'}
                                    </div>
                                </td>
                                <td>
                                    <div style="font-size: 0.8rem;">
                                        ${appointment.Email ? `<div><i class="fas fa-envelope text-info"></i> ${appointment.Email}</div>` : ''}
                                        ${appointment.PhoneNumber ? `<div><i class="fas fa-phone text-success"></i> ${appointment.PhoneNumber}</div>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        return tableHTML;
    }

    // Helper function to format date and time
    function formatDateTime(dateTimeString) {
        try {
            const date = new Date(dateTimeString);
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleDateString('en-US', options);
        } catch (error) {
            return dateTimeString;
        }
    }

    // Helper function to get status badge class
    function getStatusBadgeClass(status) {
        switch (status?.toLowerCase()) {
            case 'scheduled':
                return 'bg-success';
            case 'pending':
                return 'bg-warning text-dark';
            case 'completed':
                return 'bg-info';
            case 'cancelled':
                return 'bg-danger';
            default:
                return 'bg-secondary';
        }
    }

    // Export functions
    function exportToExcel() {
        // Prepare data with all fields including Bio Description, Degree, Institution, Room
        const exportData = filteredDoctors.map(doctor => ({
            'Full Name': doctor.name || 'N/A',
            'Email': doctor.email || 'N/A',
            'Phone Number': doctor.phone || 'N/A',
            'Bio Description': doctor.bioDescription || doctor.bio || 'N/A',
            'Description': doctor.description || 'N/A',
            'Degree': doctor.degree || 'N/A',
            'Institution': doctor.institution || 'N/A',
            'Specialty': doctor.specialty || 'N/A',
            'Room': doctor.room || 'N/A'
        }));

        // Create worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);

        // Set column widths for better readability
        const colWidths = [
            { wch: 20 }, // Full Name
            { wch: 25 }, // Email
            { wch: 15 }, // Phone Number
            { wch: 35 }, // Bio Description - increased width
            { wch: 30 }, // Description
            { wch: 20 }, // Degree - increased width
            { wch: 30 }, // Institution - increased width
            { wch: 20 }, // Specialty
            { wch: 15 }  // Room - increased width
        ];
        ws['!cols'] = colWidths;

        // Create workbook and add worksheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Doctors List');

        // Generate filename with current date
        const currentDate = new Date().toISOString().split('T')[0];
        const filename = `doctors_list_${currentDate}.xlsx`;

        // Save file
        XLSX.writeFile(wb, filename);
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;

        // Create PDF in landscape orientation for better table display
        const doc = new jsPDF('landscape', 'mm', 'a4');

        // Colors
        const primaryColor = [102, 126, 234]; // Primary blue
        const headerColor = [67, 56, 202]; // Darker blue
        const alternateRowColor = [248, 250, 252]; // Light gray
        const textColor = [31, 41, 55]; // Dark gray

        // Header section
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 297, 25, 'F'); // Full width header background

        // Logo/Icon area (simulated)
        doc.setFillColor(255, 255, 255);
        doc.circle(20, 12.5, 8, 'F');
        doc.setTextColor(...primaryColor);
        doc.setFontSize(16);
        doc.text('✚', 17, 16);

        // Title
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('MediCare Plus - Doctors List', 35, 16);

        // Subtitle with current date and count
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        doc.text(`Generated on ${currentDate} | Total Doctors: ${filteredDoctors.length}`, 35, 21);

        // Prepare table data with all required fields
        const tableHeaders = [
            'Full Name',
            'Email',
            'Phone',
            'Bio Description',
            'Description',
            'Degree',
            'Institution',
            'Specialty',
            'Room'
        ];

        const tableData = filteredDoctors.map(doctor => [
            doctor.name || 'N/A',
            doctor.email || 'N/A',
            doctor.phone || 'N/A',
            // Truncate long bio descriptions for better PDF layout
            (doctor.bioDescription || doctor.bio || 'N/A').length > 50 ?
                (doctor.bioDescription || doctor.bio || 'N/A').substring(0, 50) + '...' :
                (doctor.bioDescription || doctor.bio || 'N/A'),
            // Truncate long descriptions for better PDF layout
            (doctor.description || 'N/A').length > 40 ?
                (doctor.description || 'N/A').substring(0, 40) + '...' :
                (doctor.description || 'N/A'),
            doctor.degree || 'N/A',
            doctor.institution || 'N/A',
            doctor.specialty || 'N/A',
            doctor.room || 'N/A'
        ]);

        // Create table with enhanced styling
        doc.autoTable({
            head: [tableHeaders],
            body: tableData,
            startY: 35,
            theme: 'striped',
            headStyles: {
                fillColor: headerColor,
                textColor: [255, 255, 255],
                fontSize: 9, // Reduced font size for more columns
                fontStyle: 'bold',
                halign: 'center',
                cellPadding: { top: 3, right: 2, bottom: 3, left: 2 }
            },
            bodyStyles: {
                fontSize: 7, // Reduced font size for better fit
                textColor: textColor,
                cellPadding: { top: 2, right: 1, bottom: 2, left: 1 }
            },
            alternateRowStyles: {
                fillColor: alternateRowColor
            },
            columnStyles: {
                0: { cellWidth: 25, fontStyle: 'bold' }, // Full Name
                1: { cellWidth: 30 }, // Email
                2: { cellWidth: 18 }, // Phone
                3: { cellWidth: 35 }, // Bio Description
                4: { cellWidth: 30 }, // Description
                5: { cellWidth: 20 }, // Degree
                6: { cellWidth: 30 }, // Institution
                7: { cellWidth: 25 }, // Specialty
                8: { cellWidth: 15 }  // Room
            },
            styles: {
                overflow: 'linebreak',
                cellPadding: 1.5,
                fontSize: 7,
                lineColor: [200, 200, 200],
                lineWidth: 0.1
            },
            margin: { left: 8, right: 8 },
            didDrawPage: function(data) {
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                const currentPage = doc.internal.getCurrentPageInfo().pageNumber;

                // Footer background
                doc.setFillColor(...alternateRowColor);
                doc.rect(0, 195, 297, 15, 'F');

                // Footer text
                doc.setTextColor(...textColor);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Page ${currentPage} of ${pageCount}`, 20, 205);
                doc.text('Generated by MediCare Plus Hospital Management System', 150, 205);

                // Footer line
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(1);
                doc.line(8, 195, 289, 195);
            }
        });

        // Generate filename with current date
        const currentDateTime = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
        const filename = `doctors_list_${currentDateTime}.pdf`;

        // Save the PDF
        doc.save(filename);
    }
</script>
</body>
</html>
