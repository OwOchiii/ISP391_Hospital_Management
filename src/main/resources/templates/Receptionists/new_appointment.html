<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - MediCare Plus</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.5/purify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #007bff;
            --accent-color: #007bff;
            --patient-primary: #007bff;
            --patient-secondary: #007bff;
            --patient-accent: #007bff;
            --patient-light: #e6f0ff;
            --patient-dark: #007bff;
            --text-dark: #1f2937;
            --text-light: #6c757d;
            --text-muted: #9ca3af;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --success-color: #007bff;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #007bff;
            --border-color: #e5e7eb;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .char-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: var(--warning-color);
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
            overflow-x: hidden;
        }

        .main-content {
            min-height: 100vh;
        }

        .top-header {
            background: var(--bg-white);
            height: var(--header-height);
            padding: 0 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-left h4 {
            font-size: 1.8rem; /* Updated font size for Book Appointment header */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .page-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title i {
            color: var(--success-color);
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item a {
            color: var(--success-color);
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: var(--text-muted);
        }

        .search-section {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            padding-right: 3rem;
        }

        .search-bar button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--success-color);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .search-results {
            margin-top: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .search-results table {
            width: 100%;
            border-collapse: collapse;
        }

        .search-results th, .search-results td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .search-results th {
            background: var(--bg-light);
            font-weight: 600;
        }

        .search-results tr {
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .search-results tr:hover {
            background: var(--patient-light);
        }

        .form-section {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--success-color);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .required-asterisk {
            color: var(--error-color);
            font-weight: 700;
        }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-white);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--success-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            background: var(--bg-white);
        }

        .form-control:read-only, .form-control:disabled {
            background: var(--bg-light);
            color: var(--text-muted);
        }

        .time-selection {
            margin-top: 1rem;
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .time-slot {
            padding: 0.3rem 0.9rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-white);
            color: var(--text-dark);
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .time-slot:hover:not(.disabled) {
            border-color: var(--success-color);
            background: rgba(0, 123, 255, 0.1);
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .time-slot.disabled {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .time-slot.disabled::after {
            content: '✕';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--error-color);
            font-weight: 700;
        }

        .contact-field {
            position: relative;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .error-message i {
            font-size: 1rem;
        }

        .btn-primary-custom {
            background: var(--success-color);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            color: white;
        }

        .btn-outline-custom {
            border: 2px solid var(--success-color);
            color: var(--success-color);
            background: transparent;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline-custom:hover {
            background: var(--success-color);
            color: white;
            transform: translateY(-2px);
            text-decoration: none;
        }
        /* Confirmation Modal */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .confirmation-overlay.active {
            display: flex;
        }

        .confirmation-dialog {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confirmation-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success-color), #007bff);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .confirmation-message {
            color: var(--text-light);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .confirmation-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .doctor-info-display {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
            display: none;
        }

        .doctor-info-display.show {
            display: block;
        }

        .doctor-card {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .doctor-details h6 {
            margin: 0;
            font-weight: 600;
            color: var(--text-dark);
        }

        .doctor-details p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        @media (max-width: 768px) {
            .page-content {
                padding: 1rem;
            }

            .form-section, .search-section {
                padding: 1.5rem;
            }

            .top-header {
                padding: 0 1rem;
            }

            .time-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .confirmation-actions {
                flex-direction: column;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--success-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .success-message {
            background: var(--patient-light);
            border: 1px solid var(--success-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--patient-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message i {
            color: var(--success-color);
        }

        .readonly, .form-control:disabled {
            background: #f8f9fa;
            color: #6c757d;
            pointer-events: none;
        }

        .form-control.error, .form-select.error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25) !important;
        }

        .time-grid.error {
            border: 2px solid var(--error-color);
            border-radius: 12px;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.05);
        }

        .textarea.error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25) !important;
        }
    </style>
</head>
<body>
<div class="main-content" id="mainContent">
    <div class="top-header">
        <div class="header-left">
            <h4 class="mb-0">Book Appointment</h4>
        </div>
        <div class="header-right">
            <a th:href="@{/receptionist/dashboard}" class="btn-outline-custom">
                <i class="bi bi-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <div class="page-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-calendar-plus"></i>
                Book New Appointment
            </h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/receptionist/dashboard}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Book Appointment</li>
                </ol>
            </nav>
        </div>

        <div id="successMessage" class="success-message d-none">
            <i class="bi bi-check-circle-fill"></i>
            <span>Appointment booked successfully!</span>
        </div>

        <div class="search-section">
            <h2 class="section-title">
                <i class="bi bi-search"></i>
                Search Patient
            </h2>
            <form id="searchPatientForm" onsubmit="searchPatients(event)">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="searchQuery" class="form-label">Search by Name, Phone</label>
                        <div class="search-bar">
                            <input type="text" id="searchQuery" class="form-control"
                                   placeholder="Enter name, phone, or patient ID"/>
                            <button type="submit">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            <div class="search-results d-none" id="searchResults">
                <table>
                    <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                    </tr>
                    </thead>
                    <tbody id="searchResultsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">
                <i class="bi bi-clipboard2-pulse"></i>
                Appointment Details
            </h2>

            <form id="appointmentForm" onsubmit="submitForm(event)">
                <input type="hidden" name="appointmentId" id="appointmentId"/>
                <input type="hidden" name="patientId" id="patientIdInput"/>
                <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="specialtyId" class="form-label">
                            Medical Specialty <span class="required-asterisk">*</span>
                        </label>
                        <select id="specialtyId" name="specialtyId" class="form-select" onchange="updateDoctors()"
                                required>
                            <option value="">Select Medical Specialty</option>
                            <option th:each="spec : ${specializations}"
                                    th:value="${spec.specId}"
                                    th:data-price="${spec.price}"
                                    th:text="${spec.specName} + ' - $' + ${spec.price}">
                            </option>
                        </select>
                        <div id="specialtyIdError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Please select a medical specialty</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="doctorId" class="form-label">
                            Select Doctor <span class="required-asterisk">*</span>
                        </label>
                        <select id="doctorId" name="doctorId" class="form-select" onchange="updateDoctorsAndTimeSlots()"
                                required>
                            <option value="">Choose a Doctor</option>
                        </select>
                        <div id="doctorIdError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Please select a doctor</span>
                        </div>
                        <div class="doctor-info-display" id="doctorInfoDisplay">
                            <div class="doctor-card">
                                <div class="doctor-avatar" id="doctorAvatar">DR</div>
                                <div class="doctor-details">
                                    <h6 id="doctorName"></h6>
                                    <p id="doctorSpecialty"></p>
                                    <p id="doctorBio"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="appointmentDate" class="form-label">
                            Appointment Date <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" id="appointmentDate" name="appointmentDate" class="form-control" required
                               placeholder="MM/DD/YYYY"/>
                        <div id="appointmentDateError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Please select an appointment date</span>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">
                        Appointment Time <span class="required-asterisk">*</span>
                    </label>
                    <div class="time-selection">
                        <div class="time-grid" id="timeGrid">
                            <button type="button" class="time-slot" onclick="selectTime('08:00:00', this)"
                                    data-time="08:00:00">08:00 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('08:30:00', this)"
                                    data-time="08:30:00">08:30 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('09:00:00', this)"
                                    data-time="09:00:00">09:00 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('09:30:00', this)"
                                    data-time="09:30:00">09:30 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('10:00:00', this)"
                                    data-time="10:00:00">10:00 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('10:30:00', this)"
                                    data-time="10:30:00">10:30 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('11:00:00', this)"
                                    data-time="11:00:00">11:00 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('11:30:00', this)"
                                    data-time="11:30:00">11:30 AM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('14:00:00', this)"
                                    data-time="14:00:00">02:00 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('14:30:00', this)"
                                    data-time="14:30:00">02:30 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('15:00:00', this)"
                                    data-time="15:00:00">03:00 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('15:30:00', this)"
                                    data-time="15:30:00">03:30 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('16:00:00', this)"
                                    data-time="16:00:00">04:00 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('16:30:00', this)"
                                    data-time="16:30:00">04:30 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('17:00:00', this)"
                                    data-time="17:00:00">05:00 PM
                            </button>
                            <button type="button" class="time-slot" onclick="selectTime('17:30:00', this)"
                                    data-time="17:30:00">05:30 PM
                            </button>
                        </div>
                        <input type="hidden" value="" id="appointmentTime" name="appointmentTime" required/>
                        <div id="appointmentTimeError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Please select an appointment time</span>
                        </div>
                    </div>
                </div>

                <h3 class="section-title">
                    <i class="bi bi-person-lines-fill"></i>
                    Contact Information
                </h3>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fullName" class="form-label">Full Name <span
                                class="required-asterisk">*</span></label>
                        <input type="text" id="fullName" name="fullName" class="form-control readonly" readonly
                               required/>
                        <div id="fullNameError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Full name is required</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="phoneNumber" class="form-label">
                            Phone Number <span class="required-asterisk">*</span>
                        </label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="form-control readonly" readonly
                               required/>
                        <div id="phoneNumberError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Valid phone number is required</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">
                            Email Address <span class="required-asterisk">*</span>
                        </label>
                        <input type="email" id="email" name="email" class="form-control readonly" maxlength="50"
                               readonly required/>
                        <div id="emailError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Valid email address is required</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="dateOfBirth" class="form-label">
                            Date of Birth <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" id="dateOfBirth" name="dateOfBirth" class="form-control readonly" readonly
                               required/>
                        <div id="dateOfBirthError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Valid date of birth is required</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="gender" class="form-label">
                            Gender <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" id="gender" name="gender" class="form-control readonly" readonly required/>
                        <div id="genderError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Gender is required</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="country" class="form-label">Country <span class="required-asterisk">*</span></label>
                        <input type="text" id="country" name="country" class="form-control readonly" readonly required/>
                        <div id="countryError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Country is required</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="province" class="form-label">Province/City <span class="required-asterisk">*</span></label>
                        <input type="text" id="province" name="province" class="form-control readonly" readonly
                               required/>
                        <div id="provinceError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Province/City is required</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="district" class="form-label">District <span
                                class="required-asterisk">*</span></label>
                        <input type="text" id="district" name="district" class="form-control readonly" readonly
                               required/>
                        <div id="districtError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>District is required</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="streetAddress" class="form-label">Street Address <span
                                class="required-asterisk">*</span></label>
                        <input type="text" id="streetAddress" name="streetAddress" class="form-control readonly"
                               readonly required/>
                        <div id="streetAddressError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Street Address is required</span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="postalCode" class="form-label">Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" class="form-control readonly" readonly/>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="addressType" class="form-label">Address Type <span
                                class="required-asterisk">*</span></label>
                        <input type="text" id="addressType" name="addressType" class="form-control readonly" readonly
                               required/>
                        <div id="addressTypeError" class="error-message d-none">
                            <i class="bi bi-exclamation-circle"></i>
                            <span>Address Type is required</span>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="description" class="form-label">
                        Reason for Visit / Symptoms <span class="required-asterisk">*</span>
                    </label>
                    <textarea id="description" name="description" class="form-control readonly" rows="4" maxlength="250"
                              placeholder="Please describe your symptoms or reason for the appointment..."
                              style="resize: none;" oninput="sanitizeOnInput(this); autoResize(this)"
                              disabled required></textarea>
                    <small class="text-muted">Maximum 250 characters</small>
                    <div id="descriptionError" class="error-message d-none">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Please describe your reason for visit or symptoms</span>
                    </div>
                </div>

                <div class="text-center">
                    <button type="button" class="btn-primary-custom" onclick="showConfirmation()">
                        <i class="bi bi-calendar-check"></i>
                        Book Appointment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Here ís model-->
<div id="confirmationModal" style="display: none;" class="confirmation-overlay">
    <div class="confirmation-dialog">
        <div class="confirmation-icon">
            <i class="bi bi-check-circle"></i>
        </div>
        <h3 class="confirmation-title">Confirm Appointment</h3>
        <p class="confirmation-message">Are you sure you want to book this appointment?</p>
        <div class="confirmation-actions">
            <button class="btn-primary-custom" onclick="confirmBooking(true)">
                <i class="bi bi-check-circle"></i> Confirm
            </button>
            <button class="btn-outline-custom" onclick="confirmBooking(false)">
                <i class="bi bi-x-circle"></i> Cancel
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // Initialize date picker and set fields read-only on page load
    document.addEventListener('DOMContentLoaded', function () {
        initializeDatePicker();
        setFieldsReadOnly();

        // Add event listener to clear date error when user selects
        const appointmentDate = document.getElementById('appointmentDate');
        if (appointmentDate) {
            appointmentDate.addEventListener('change', function() {
                const dateError = document.getElementById('appointmentDateError');
                if (dateError) {
                    dateError.classList.add('d-none');
                }
                this.classList.remove('error');
            });
        }
    });

    function initializeDatePicker() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const maxDate = new Date(tomorrow);
        maxDate.setDate(tomorrow.getDate() + 7);

        const dateInput = document.getElementById('appointmentDate');
        if (dateInput) {
            $(dateInput).datepicker({
                dateFormat: 'mm/dd/yy',
                minDate: tomorrow,
                maxDate: maxDate,
                beforeShowDay: function (date) {
                    const day = date.getDay();
                    return [day !== 0 && day !== 6, day !== 0 && day !== 6 ? '' : 'ui-state-disabled'];
                },
                onSelect: function (dateText) {
                    updateTimeSlots();
                }
            });
        }
    }

    function setFieldsReadOnly() {
        const fields = ['fullName', 'phoneNumber', 'email', 'dateOfBirth', 'gender', 'country', 'province', 'district', 'streetAddress', 'postalCode', 'addressType'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.readOnly = true;
                el.classList.add('readonly');
            }
        });
        // Disable description textarea by default
        const description = document.getElementById('description');
        if (description) {
            description.disabled = true;
            description.classList.add('readonly');
        }
    }

    function searchPatients(event) {
        event.preventDefault();
        const query = document.getElementById('searchQuery').value.trim();
        if (!query) {
            alert('Please enter a search query.');
            return;
        }
        $.ajax({
            url: '/api/patients',
            method: 'GET',
            data: {search: query, page: 1}, // Always send page=1
            success: function (response) {
                const resultsContainer = document.getElementById('searchResults');
                const resultsBody = document.getElementById('searchResultsBody');
                resultsBody.innerHTML = '';
                if (response && response.patients && response.patients.length > 0) {
                    response.patients.forEach(function (patient) {
                        const row = document.createElement('tr');
                        // Sử dụng patient.patientId để lấy đúng Patient ID
                        row.innerHTML = `
                            <td>${patient.id}</td>
                            <td>${patient.name}</td>
                            <td>${patient.phone}</td>
                            <td>${patient.email}</td>
                        `;
                        row.addEventListener('click', function () {
                            selectPatient(patient);
                        });
                        resultsBody.appendChild(row);
                    });
                    resultsContainer.classList.remove('d-none');
                } else {
                    resultsBody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                    resultsContainer.classList.remove('d-none');
                }
            },
            error: function () {
                const resultsContainer = document.getElementById('searchResults');
                const resultsBody = document.getElementById('searchResultsBody');
                resultsBody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                resultsContainer.classList.remove('d-none');
            }
        });
    }

    function selectPatient(patient) {
        document.getElementById('patientIdInput').value = patient.id;
        setReadOnlyField('fullName', patient.name);
        setReadOnlyField('phoneNumber', patient.phone);
        setReadOnlyField('email', patient.email);
        // Format dateOfBirth to MM/DD/YYYY
        const dob = patient.dateOfBirth ? new Date(patient.dateOfBirth).toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: 'numeric'
        }) : '';
        setReadOnlyField('dateOfBirth', dob);
        setReadOnlyField('gender', patient.gender);
        setReadOnlyField('country', patient.country || 'Việt Nam');
        setReadOnlyField('province', patient.province);
        setReadOnlyField('district', patient.district);
        setReadOnlyField('streetAddress', patient.streetAddress);
        setReadOnlyField('postalCode', patient.postalCode);
        setReadOnlyField('addressType', patient.addressType);
        // Enable description textarea
        const description = document.getElementById('description');
        description.disabled = false;
        description.classList.remove('readonly');
        description.value = patient.description ? patient.description.substring(0, 250) : '';

        // Add event listener to clear description error
        description.addEventListener('input', function() {
            if (this.value.trim()) {
                const descError = document.getElementById('descriptionError');
                if (descError) {
                    descError.classList.add('d-none');
                }
                this.classList.remove('error');
            }
        });

        document.getElementById('searchResults').classList.add('d-none');
    }

    function setReadOnlyField(id, value) {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = value || '';
        el.readOnly = true;
        el.classList.add('readonly');
    }

    // Enhanced validation function
    function validateForm() {
        let isValid = true;

        // Clear previous errors
        clearAllErrors();

        // Validate Medical Specialty
        const specialty = document.getElementById('specialtyId');
        if (!specialty.value) {
            showError('specialtyId', 'specialtyIdError', 'Please select a medical specialty');
            isValid = false;
        }

        // Validate Doctor Selection
        const doctor = document.getElementById('doctorId');
        if (!doctor.value) {
            showError('doctorId', 'doctorIdError', 'Please select a doctor');
            isValid = false;
        }

        // Validate Appointment Date
        const appointmentDate = document.getElementById('appointmentDate');
        if (!appointmentDate.value) {
            showError('appointmentDate', 'appointmentDateError', 'Please select an appointment date');
            isValid = false;
        }

        // Validate Appointment Time
        const appointmentTime = document.getElementById('appointmentTime');
        if (!appointmentTime.value) {
            showTimeError();
            isValid = false;
        }

        // Validate Description/Reason for Visit
        const description = document.getElementById('description');
        if (!description.value.trim()) {
            showError('description', 'descriptionError', 'Please describe your reason for visit or symptoms');
            isValid = false;
        }

        return isValid;
    }

    function showError(fieldId, errorId, message) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(errorId);

        if (field) {
            field.classList.add('error');
        }

        if (errorDiv) {
            errorDiv.classList.remove('d-none');
            errorDiv.querySelector('span').textContent = message;
        }
    }

    function showTimeError() {
        const timeGrid = document.getElementById('timeGrid');
        const errorDiv = document.getElementById('appointmentTimeError');

        if (timeGrid) {
            timeGrid.classList.add('error');
        }

        if (errorDiv) {
            errorDiv.classList.remove('d-none');
            errorDiv.querySelector('span').textContent = 'Please select an appointment time';
        }
    }

    function clearAllErrors() {
        // Clear field errors
        const fields = ['specialtyId', 'doctorId', 'appointmentDate', 'description'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + 'Error');

            if (field) {
                field.classList.remove('error');
            }
            if (errorDiv) {
                errorDiv.classList.add('d-none');
            }
        });

        // Clear time grid error
        const timeGrid = document.getElementById('timeGrid');
        const timeErrorDiv = document.getElementById('appointmentTimeError');

        if (timeGrid) {
            timeGrid.classList.remove('error');
        }
        if (timeErrorDiv) {
            timeErrorDiv.classList.add('d-none');
        }
    }

    async function updateDoctors() {
        // Clear specialty error when user selects
        const specialtyError = document.getElementById('specialtyIdError');
        if (specialtyError) {
            specialtyError.classList.add('d-none');
        }
        document.getElementById('specialtyId').classList.remove('error');

        const specialtyId = document.getElementById('specialtyId').value;
        const doctorSelect = document.getElementById('doctorId');
        const doctorInfo = document.getElementById('doctorInfoDisplay');

        doctorSelect.innerHTML = '<option value="">Choose a Doctor</option>';
        doctorInfo.classList.remove('show');

        if (specialtyId) {
            doctorSelect.classList.add('loading');
            let doctors = await getDoctorBySpecialtyId(specialtyId);
            setTimeout(() => {
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.doctorId;
                    option.text = `Dr. ${doctor.fullName}`;
                    option.setAttribute('data-bio', doctor.bioDescription);
                    option.setAttribute('data-name', doctor.fullName);
                    doctorSelect.appendChild(option);
                });
                doctorSelect.classList.remove('loading');
            }, 500);
        }

        const appointmentDate = document.getElementById('appointmentDate').value;
        if (appointmentDate && doctorSelect.value) {
            updateTimeSlots();
        }
    }

    function getDoctorBySpecialtyId(specialtyId) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/api/doctor/specialty/' + specialtyId,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    resolve(response); // Resolve with the API response (array of doctors)
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching doctors:', error);
                    reject([]); // Reject with an empty array on error
                }
            });
        });
    }

    function updateDoctorsAndTimeSlots() {
        // Clear doctor error when user selects
        const doctorError = document.getElementById('doctorIdError');
        if (doctorError) {
            doctorError.classList.add('d-none');
        }
        document.getElementById('doctorId').classList.remove('error');

        showDoctorInfo();
        const appointmentDate = document.getElementById('appointmentDate').value;
        if (appointmentDate) {
            updateTimeSlots();
        }
    }

    function showDoctorInfo() {
        const doctorSelect = document.getElementById('doctorId');
        const selectedOption = doctorSelect.options[doctorSelect.selectedIndex];
        const doctorInfo = document.getElementById('doctorInfoDisplay');

        if (selectedOption && selectedOption.value) {
            const doctorName = selectedOption.getAttribute('data-name');
            const doctorBio = selectedOption.getAttribute('data-bio');
            const specialtySelect = document.getElementById('specialtyId');
            const specialtyName = specialtySelect.options[specialtySelect.selectedIndex].text.split(' - ')[0];

            document.getElementById('doctorName').textContent = `Dr. ${doctorName}`;
            document.getElementById('doctorSpecialty').textContent = specialtyName;
            document.getElementById('doctorBio').textContent = doctorBio;
            document.getElementById('doctorAvatar').textContent = doctorName.substring(0, 2).toUpperCase();

            doctorInfo.classList.add('show');
        } else {
            doctorInfo.classList.remove('show');
        }
    }

    async function updateTimeSlots() {
        const dateInput = document.getElementById('appointmentDate').value;
        const doctorId = document.getElementById('doctorId').value;

        if (dateInput && doctorId) {
            const timeSlots = document.querySelectorAll('.time-slot');
            timeSlots.forEach(slot => {
                slot.classList.remove('selected', 'disabled');
                slot.title = "Available";
            });
            document.getElementById('appointmentTime').value = '';

            const bookedTimes = await getAvailableTimeSlots(doctorId,dateInput);
            setTimeout(() => {
                timeSlots.forEach(slot => {
                    const time = slot.getAttribute('data-time');
                    if (bookedTimes.includes(time)) {
                        slot.classList.add('disabled');
                        slot.title = "This time slot is already booked";
                    } else {
                        slot.title = "Available";
                    }
                });
            }, 500);
        }
    }

    function getAvailableTimeSlots(doctorId, dateInput) {
        const date = new Date(dateInput);
        date.setDate(date.getDate() + 1);
        const formattedDate = date.toISOString().split('T')[0];
        return new Promise((resolve, reject) => {
            $.ajax({
                url: `/api/doctor/appointment?doctorId=${doctorId}&date=${formattedDate}`,
                method: 'GET',
                dataType: 'json',
                success: function (response) {
                    resolve(response); // Array of booked times, e.g., ["09:00:00", "14:30:00"]
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching time slots:', error);
                    reject([]); // Return empty array on error
                }
            });
        });
    }

    function selectTime(time, button) {
        if (!button.classList.contains('disabled')) {
            // Clear time error when user selects
            const timeError = document.getElementById('appointmentTimeError');
            if (timeError) {
                timeError.classList.add('d-none');
            }
            document.getElementById('timeGrid').classList.remove('error');

            document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            document.getElementById('appointmentTime').value = time;
        }
    }

    // Function to auto-resize textarea based on content
    function autoResize(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    function sanitizeOnInput(element) {
        let value = element.value;
        value = value.replace(/[<>"'&]/g, '');
        value = value.trim().replace(/\s+/g, ' ');
        if (value.length > 250) {
            value = value.substring(0, 250);
            alert('Tối đa 250 ký tự được phép cho mô tả triệu chứng.');
        }
        element.value = value;
        autoResize(element);
    }

    // Show confirmation dialog
    function showConfirmation() {
        // Validate form before showing confirmation
        if (!validateForm()) {
            // Scroll to first error
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // Lấy giá trị từ các trường
        const specialty = document.getElementById('specialtyId').value;
        const doctor = document.getElementById('doctorId').value;
        const date = document.getElementById('appointmentDate').value;
        const time = document.getElementById('appointmentTime').value;
        const phone = document.getElementById('phoneNumber').value.trim();
        const email = document.getElementById('email').value.trim();

        // Kiểm tra các trường bắt buộc
        if (!specialty) {
            alert('Please select a medical specialty.');
            return;
        }
        if (!doctor) {
            alert('Please select a doctor.');
            return;
        }
        if (!date) {
            alert('Please select an appointment date.');
            return;
        }
        if (!time) {
            alert('Please select an appointment time.');
            return;
        }
        if (!phone) {
            alert('Phone number is required.');
            return;
        }
        if (!email) {
            alert('Email address is required.');
            return;
        }

        // Kiểm tra định dạng số điện thoại
        const phoneRegex = /^0\d{9}$|^0\d{11}$/;
        if (!phoneRegex.test(phone)) {
            alert('Phone number must start with 0 and be either 10 or 12 digits long, with no spaces.');
            return;
        }

        // Kiểm tra định dạng email
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailRegex.test(email)) {
            alert('Please enter a valid email address.');
            return;
        }

        // Sanitize description before confirmation
        let description = document.getElementById('description').value.trim();
        description = sanitizeDescription(description);
        document.getElementById('description').value = description;

        // Hiển thị modal
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            modal.style.display = 'flex'; // Use flex to center the dialog
        }
    }

    function confirmBooking(confirm) {
        const modal = document.getElementById('confirmationModal');
        if (modal) {
            modal.style.display = 'none';
        }

        if (confirm) {
            // Sanitize data before sending
            const phoneNumber = document.getElementById('phoneNumber').value.replace(/\s+/g, '');
            const email = document.getElementById('email').value.replace(/\s+/g, '');
            let description = document.getElementById('description').value.trim();

            // Final sanitization of description
            description = sanitizeDescription(description);

            document.getElementById('phoneNumber').value = phoneNumber;
            document.getElementById('email').value = email;
            document.getElementById('description').value = description;

            // Format the appointment date for backend
            const appointmentDateInput = document.getElementById('appointmentDate').value;
            let formattedDate = '';

            if (appointmentDateInput && appointmentDateInput.includes('/')) {
                // Convert from MM/DD/YYYY to ISO format (YYYY-MM-DD)
                const [month, day, year] = appointmentDateInput.split('/');
                formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }

            // Debug info - check what data is being submitted
            console.log('Submitting appointment with:');
            console.log('Patient ID:', document.getElementById('patientIdInput').value);
            console.log('Doctor ID:', document.getElementById('doctorId').value);
            console.log('Date:', document.getElementById('appointmentDate').value);
            console.log('Formatted Date:', formattedDate);
            console.log('Time:', document.getElementById('appointmentTime').value);
            console.log('Description:', document.getElementById('description').value);

            // Show loading state
            const mainContent = document.getElementById('mainContent');
            mainContent.classList.add('loading');

            // Create a proper form for submission
            const form = document.getElementById('appointmentForm');

            // Clean up any previous hidden appointmentDate fields to avoid duplicates
            const existingHiddenInputs = form.querySelectorAll('input[name="appointmentDate"][type="hidden"]');
            existingHiddenInputs.forEach(input => input.remove());

            // Create a hidden input for appointmentDate with the correct format
            const hiddenAppointmentDateInput = document.createElement('input');
            hiddenAppointmentDateInput.type = 'hidden';
            hiddenAppointmentDateInput.name = 'appointmentDate';
            hiddenAppointmentDateInput.value = formattedDate;
            form.appendChild(hiddenAppointmentDateInput);

            // Update the visible appointmentDate field to prevent it from being submitted
            const visibleDateInput = document.getElementById('appointmentDate');
            visibleDateInput.name = 'appointmentDate_display'; // Change the name so it doesn't conflict

            // Set action and method
            form.action = '/receptionist/book-appointment';
            form.method = 'POST';

            // Submit the form
            form.submit();
        }
    }

    // Reset form fields after successful submission
    function resetForm() {
        // Reset specialty, doctor and date/time selections
        document.getElementById('specialtyId').value = '';
        document.getElementById('doctorId').innerHTML = '<option value="">Choose a Doctor</option>';
        document.getElementById('appointmentDate').value = '';
        document.getElementById('appointmentTime').value = '';

        // Reset doctor info display
        document.getElementById('doctorInfoDisplay').classList.remove('show');

        // Reset patient fields
        document.getElementById('patientIdInput').value = '';

        const readOnlyFields = [
            'fullName', 'phoneNumber', 'email', 'dateOfBirth', 'gender',
            'country', 'province', 'district', 'streetAddress', 'postalCode', 'addressType'
        ];

        readOnlyFields.forEach(field => {
            setReadOnlyField(field, '');
        });

        // Reset and disable description
        const description = document.getElementById('description');
        description.value = '';
        description.disabled = true;
        description.classList.add('readonly');

        // Reset time slots
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected', 'disabled');
        });

        // Clear search results
        document.getElementById('searchQuery').value = '';
        document.getElementById('searchResults').classList.add('d-none');
    }

    // Hàm làm sạch description
    function sanitizeDescription(input) {
        // Step 1: Encode HTML characters to prevent HTML rendering
        const encoded = input.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                             .replace(/"/g, '&quot;').replace(/'/g, '&#39;');

        // Step 2: Remove or encode potential script tags and dangerous URLs
        const div = document.createElement('div');
        div.innerText = encoded; // Use innerText to ensure no HTML/script execution
        let sanitized = div.innerHTML;

        // Step 3: Remove any remaining <a> tags or URLs with dangerous protocols
        sanitized = sanitized.replace(/<a\b[^>]*>(.*?)<\/a>/gi, '$1'); // Remove <a> tags, keep content
        sanitized = sanitized.replace(/\b(javascript|data):/gi, ''); // Remove dangerous protocols

        // Step 4: Normalize whitespace and trim
        sanitized = sanitized.trim().replace(/\s+/g, ' ');

        return sanitized;
    }

    // Trim and clean input fields on blur
    function cleanInputOnBlur(id, isStrict = false) {
        const element = document.getElementById(id);
        if (!element) return;

        element.addEventListener('blur', () => {
            let value = element.value.trim();

            if (isStrict) {
                // Remove all spaces for strict fields (phone/email)
                value = value.replace(/\s+/g, '');
            } else {
                // Sanitize Description field
                if (id === 'description') {
                    value = sanitizeDescription(value);
                } else {
                    // Normalize spacing between words (one space only)
                    value = value.replace(/\s+/g, ' ');
                }
            }

            element.value = value;
        });
    }

    // Apply trimming logic to input fields
    cleanInputOnBlur('phoneNumber', true); // strict: no space at all
    cleanInputOnBlur('email', true);       // strict: no space at all
    cleanInputOnBlur('description', false); // sanitize and normalize spaces
</script>
</body>
</html>
